<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script type="text/x-mathjax-config">
    MathJax.Hub.Register.StartupHook("TeX Jax Ready",function () {
      MathJax.Hub.Insert(MathJax.InputJax.TeX.Definitions.macros,{
        cancel: ["Extension","cancel"], cancelto: ["Extension","cancel"]
      });
    });
    </script>  
   
  <title>Özkodlama (Autoencoding)</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <script
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_HTML-full"
  type="text/javascript"></script>
</head>
<body>
<div id="header">
</div>
<h1 id="özkodlama-autoencoding">Özkodlama (Autoencoding)</h1>
<p>Özkodlamanın yaptığının bir tür “veriyi sıkıştırma” işlemi olduğu
söylenebilir. Yapay öğrenmede algoritmaların denetimli ve denetimsiz
olarak ikiye ayrıldığından bahsetmiştik, özkodlama denetimsiz çalışır
yani ortada etiket yoktur, daha doğrusu özkodlama verinin kendisini
etiket olarak kullanır.</p>
<p><img src="autoenc_02.png" /></p>
<p>Yani girdi olarak verilen veriyi çıktı olarak ta kullanırsak, YSA’yı
kendi çıktısını tekrar oluşturmayı öğrenmeye zorlamış oluruz, bu YSA’yı
veriyi özetlemeye doğru yöneltecektir, ve bu tekrar oluşturma için ileri
besleme sırasında veriyi dar bir noktadan geçmeye zorlarsak (üstteki
resimde görülüyor, 7 nöronluk girdi 5 nöronluk “daha dar” bir katmandan
geçmeye zorlanıyor), bu YSA’yı “sıkıştırma” yapmaya daha da
meyillendirecektir.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> Input, Dense</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.models <span class="im">import</span> Model</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># gizli katman</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>encoding_dim <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_model():</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># girdi</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    input_img <span class="op">=</span> Input(shape<span class="op">=</span>(<span class="dv">784</span>,))</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># kodlanmis temsil</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    encoded <span class="op">=</span> Dense(encoding_dim, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>)(input_img)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># kodcozulmus temsil</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    decoded <span class="op">=</span> Dense(<span class="dv">784</span>, activation<span class="op">=</span><span class="st">&#39;sigmoid&#39;</span>)(encoded)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># bu model girdiyi tekrar olusturulmus hale cevirir</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    autoencoder <span class="op">=</span> Model(input_img, decoded)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># bu model girdiyi kodlanmis hale getirir</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    encoder <span class="op">=</span> Model(input_img, encoded)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    encoded_input <span class="op">=</span> Input(shape<span class="op">=</span>(encoding_dim,))</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ozkodlayicinin son tabakasini al bu kodcozulmus katman</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    decoder_layer <span class="op">=</span> autoencoder.layers[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># kodcozucu model</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    decoder <span class="op">=</span> Model(encoded_input, decoder_layer(encoded_input))</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    autoencoder.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">&#39;adadelta&#39;</span>, loss<span class="op">=</span><span class="st">&#39;binary_crossentropy&#39;</span>)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> autoencoder, encoder, decoder</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>: </span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    autoencoder, encoder, decoder <span class="op">=</span> get_model()</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> keras.datasets <span class="im">import</span> mnist</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    (x_train, _), (x_test, _) <span class="op">=</span> mnist.load_data()</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    x_train <span class="op">=</span> x_train.astype(<span class="st">&#39;float32&#39;</span>) <span class="op">/</span> <span class="fl">255.</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    x_test <span class="op">=</span> x_test.astype(<span class="st">&#39;float32&#39;</span>) <span class="op">/</span> <span class="fl">255.</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    x_train <span class="op">=</span> x_train.reshape((<span class="bu">len</span>(x_train), np.prod(x_train.shape[<span class="dv">1</span>:])))</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    x_test <span class="op">=</span> x_test.reshape((<span class="bu">len</span>(x_test), np.prod(x_test.shape[<span class="dv">1</span>:])))</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (x_train.shape)</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (x_test.shape)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    autoencoder.fit(x_train, x_train,</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>                    epochs<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>                    batch_size<span class="op">=</span><span class="dv">256</span>,</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>                    shuffle<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>                    validation_data<span class="op">=</span>(x_test, x_test))</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>    autoencoder.save(<span class="st">&#39;mod-autoenc-1.h5&#39;</span>)</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    encoder.save(<span class="st">&#39;mod-enc-1.h5&#39;</span>)</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>    decoder.save(<span class="st">&#39;mod-dec-1.h5&#39;</span>)</span></code></pre></div>
<p>Üstteki kodla modeli eğittikten sonra herhangi bir sayı resmini
alıyoruz, kodluyoruz, kodçözme yapıyoruz ve tekrar oluşturulmuş hali
ekrana basıyoruz,</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.datasets <span class="im">import</span> mnist</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mnist_autoenc</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>(x_train, _), (x_test, y_test) <span class="op">=</span> mnist.load_data()</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>x_test <span class="op">=</span> x_test.astype(<span class="st">&#39;float32&#39;</span>) <span class="op">/</span> <span class="fl">255.</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>autoencoder, encoder, decoder <span class="op">=</span> mnist_autoenc.get_model()</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>encoder.load_weights(<span class="st">&quot;mod-enc-1.h5&quot;</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>decoder.load_weights(<span class="st">&quot;mod-dec-1.h5&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> <span class="dv">1090</span>  <span class="co"># herhangi bir sayi resmini al</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> y_test[idx]</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>tmp <span class="op">=</span> x_test[idx, :, :].reshape(<span class="dv">1</span>,<span class="dv">28</span><span class="op">*</span><span class="dv">28</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>encoded <span class="op">=</span> encoder.predict(tmp)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (encoded.shape)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>decoded <span class="op">=</span> decoder.predict(encoded).reshape(<span class="dv">28</span>,<span class="dv">28</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (decoded.shape)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>plt.imshow(decoded)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>plt.gray()</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">&#39;autoenc_01.png&#39;</span>)</span></code></pre></div>
<pre><code>9
(1, 32)
(28, 28)</code></pre>
<p><img src="autoenc_01.png" /></p>
<p>9 resmini elde ettik.</p>
<p>Biraz onceki resmin kodlanmis halini gosterelim,</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (encoded)</span></code></pre></div>
<pre><code>[[ 13.18540382   9.90277767   2.81214857  14.67686176   3.90287089
    0.95043498   4.25797892  13.59305477   8.71218967   2.61786652
    8.67911053   5.27269077   3.68898463   6.26301765   0.           3.73920846
    4.90339994   6.61260319   8.80308342   5.41205883   0.           6.12768221
   11.42174625   3.13173342   3.79943371  11.27116108   6.003757
   10.82552242   8.44533443   4.84582376   5.63021088  11.27607727]]</code></pre>
<p>32 boyutlu bir vektör içinde reel sayılar bunlar. Şimdi bu sayıları
alıp başka bir sınıflayıcı içinde kullanabilirdim. Öyle bir uygulama
düşünelim ki mesela müşterilerin yaşı, cinsiyeti bilgisi var, biz ayrıca
herkesin fotoğrafları üzerinden bir özkodlayıcı eğitiyoruz, ve
müşterinin resmi üzerinden elde edilen üstteki gibi bir temsili
sıkıştırılmış gizli tabaka verisini yaş, cinsiyet ile beraber bu ayrı
sınıflayıcıya verip cevap bekliyoruz. Bu sınıflayıcı “potansiyel yaz
alışverişçisi mi / değil mi’’ şeklinde bir sınıflama yapıyor olabilir
mesela, belki kişilerin resminde bu sınıflayıcıya yardım edecek bir
şeyler vardır.. Bu ayrı sınıflayıcı bir YSA olabilir, ama çoğu zaman
basit lojistik regresyon bile kullanılabiliyor. Ayrıca sadece bir değil,
farklı veriler üzerinde işletilmiş pek çok özkodlayıcıdan gelen özet
bilgisini de yan yana aynı lojistik regresyona verebiliriz.</p>
<p>Zaman Serisi Özkodlaması, RNN</p>
<p>Eğer zamana bağlı bir veri yapısını özkodlamak istesek nasıl bir
model kullanırdık? Mesela birkaç boyutlu bir finans verisini (bir andaki
hisse fiyatı, satım miktarı çok boyutlu bir vektörde olabilirdi)
modelliyor olabilidiik. MNIST verisini bu şekilde kullanabiliriz
aslında, 28 x 28 boyutlu veride sanki 28 tane 28 boyutlu veriyi zamana
bağlı alıyormuşuz gibi görebilirdik, sanki resimde soldan sağa doğru
dikey şeritler alıp teker teker bunları işlediğimizi düşünebiliriz.
MNIST sayı görüntülerine bu şekilde bakmak aslında çok anlamsız değil,
mesela bir altı görüntüsünü düşünürsek soldan sağa giderken kavisli
yukarı doğru bir gidiş vardır, bu gidişi zamana bağlı bir NN
yakalayabilir.</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> Input, Dense, concatenate</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> LSTMCell, RNN</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> Input, LSTM, RepeatVector</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.models <span class="im">import</span> Model</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>latent_dim <span class="op">=</span> <span class="dv">20</span><span class="op">;</span> timesteps <span class="op">=</span> <span class="dv">28</span><span class="op">;</span> input_dim <span class="op">=</span> <span class="dv">28</span><span class="op">;</span> hist_dim <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_model():</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> Input(shape<span class="op">=</span>(timesteps, input_dim))</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    encoded <span class="op">=</span> LSTM(latent_dim,return_sequences<span class="op">=</span><span class="va">True</span>)(inputs)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    decoded <span class="op">=</span> encoded</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    decoded <span class="op">=</span> LSTM(input_dim, return_sequences<span class="op">=</span><span class="va">True</span>)(decoded)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    seq_autoencoder <span class="op">=</span> Model(inputs, decoded)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    encoder <span class="op">=</span> Model(inputs, encoded)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> seq_autoencoder, encoder</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>: </span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> keras.datasets <span class="im">import</span> mnist</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    (x_train, _), (x_test, _) <span class="op">=</span> mnist.load_data()</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    x_train <span class="op">=</span> x_train.astype(<span class="st">&#39;float32&#39;</span>) <span class="op">/</span> <span class="fl">255.</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    x_test <span class="op">=</span> x_test.astype(<span class="st">&#39;float32&#39;</span>) <span class="op">/</span> <span class="fl">255.</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (x_train.shape)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (x_test.shape)</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    seq_autoencoder, encoder <span class="op">=</span> get_model()</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    seq_autoencoder.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">&#39;adadelta&#39;</span>, loss<span class="op">=</span><span class="st">&#39;binary_crossentropy&#39;</span>)</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    seq_autoencoder.fit(x_train, x_train,</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>                        epochs<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>                        batch_size<span class="op">=</span><span class="dv">256</span>,</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>                        shuffle<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>                        validation_data<span class="op">=</span>(x_test, x_test))</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    seq_autoencoder.save(<span class="st">&#39;mod-rnn-autoenc-sim.h5&#39;</span>)</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>    encoder.save(<span class="st">&#39;mod-rnn-enc-sim.h5&#39;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mnist_autoenc_rnn_simple</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>seq_autoencoder, encoder <span class="op">=</span> mnist_autoenc_rnn_simple.get_model()</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>seq_autoencoder.load_weights(<span class="st">&quot;mod-rnn-autoenc-sim.h5&quot;</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>encoder.load_weights(<span class="st">&quot;mod-rnn-enc-sim.h5&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>decoded <span class="op">=</span> seq_autoencoder.predict(tmp).reshape(<span class="dv">28</span>,<span class="dv">28</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (decoded.shape)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>plt.imshow(decoded)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>plt.gray()</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">&#39;autoenc_03.png&#39;</span>)</span></code></pre></div>
<p><img src="autoenc_03.png" /></p>
<p>Varyasyonel Özkodlayıcılar (Variational Autoencoder -VAE-)</p>
<p>Standard özkodlayıcıların bir problemi kodlama yaptıkları daralmış
alandaki vektörlerin sürekli olmayabileceği, ve buradaki değerlerin
kolay bir şekilde interpolasyon yapılmasındaki bazı zorluklar.</p>
<p>VAE özkodlayıcılarda, kodlayıcı tabaka bir tamamen bağlanmış / yoğun
(dense) bir katmandan geçiyor ama bir değişiklik var; yoğun katman <span
class="math inline">\(\mu,\sigma\)</span> rasgele <em>değişkenleri</em>
haline geliyor ve ondan bir sonraki katman bu değişkenlerden örneklem
alıyor! Bu dahiyene bir düşünce. Fakat akla gelebilir - YSA yapısı
deterministik bir yapıdır, örneklem, yani zar atma rasgele (stochastic)
bir hesap. Bu kavramı YSA mekanizmasına nasıl dahil ediyoruz?</p>
<p><img src="autoenc_06.png" /></p>
<p>Çözüm örneklem operasyonunu gürültü, yani Gaussian <span
class="math inline">\(N(0,1)\)</span> + <span
class="math inline">\(\mu\)</span> çarpı <span
class="math inline">\(\sigma\)</span> olarak modellemek, bu şekilde
sanki <span class="math inline">\(N(\mu,\sigma)\)</span>’dan örneklem
alıyoruz, ama eğitilen, optimize edilen çarpma, toplama üzerinden <span
class="math inline">\(\mu,\sigma\)</span> değişkenleri, ve halen YSA
mekanizması devrede ve bu değişkenler deterministik değişkenler. Gürültü
işin içinde var, ama gürültü eh, Gaussian sıfır merkezli bir stardart
sapmalı gürültü. Bir gürültü bir diğerinden farklı değil, model için
hepsi aynı gürültü.</p>
<p>Üstteki mantığın temelinde şu bilgi var: Biliyoruz ki herhangi bir
dağılıma sahip rasgele değişken <span
class="math inline">\(z\)</span>’yi bir <span
class="math inline">\(g\)</span> fonksiyonu kullanarak <span
class="math inline">\(X=g(z)\)</span> ile başka bir dağılıma
çevirebiliyoruz. Altta örneği görülüyor, soldaki resim Gaussian
dağılımdan, sağdaki resim soldaki verilerin <span
class="math inline">\(g(z) = z/10 + z/||z||\)</span> ile başka bir
dağılıma eşlenmiş hali ve bu yeni dağılım bir çember şeklini oluşturmuş.
VAE’nin rasgele dağılımlar yaratabilmesinin arkasında yatan gizem bu
işte. Eğitim ile VAE <span class="math inline">\(g\)</span>’yi öğrenmiş
oluyor, ki bu bir determinstik fonksiyon.</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random, numpy.linalg <span class="im">as</span> lin, pandas <span class="im">as</span> pd</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.random.randn(<span class="dv">1000</span>,<span class="dv">2</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> pd.DataFrame(x)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>x[<span class="st">&#39;n&#39;</span>] <span class="op">=</span> np.sqrt(x[<span class="dv">0</span>]<span class="op">*</span>x[<span class="dv">0</span>] <span class="op">+</span> x[<span class="dv">1</span>]<span class="op">*</span>x[<span class="dv">1</span>])</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>x[<span class="st">&#39;g0&#39;</span>] <span class="op">=</span> (x[<span class="dv">0</span>]<span class="op">/</span><span class="fl">10.0</span>) <span class="op">+</span> x[<span class="dv">0</span>]<span class="op">/</span>x[<span class="st">&#39;n&#39;</span>]</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>x[<span class="st">&#39;g1&#39;</span>] <span class="op">=</span> (x[<span class="dv">1</span>]<span class="op">/</span><span class="fl">10.0</span>) <span class="op">+</span> x[<span class="dv">1</span>]<span class="op">/</span>x[<span class="st">&#39;n&#39;</span>]</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>plt.plot(x[<span class="dv">0</span>],x[<span class="dv">1</span>],<span class="st">&#39;.&#39;</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>plt.plot(x[<span class="st">&#39;g0&#39;</span>],x[<span class="st">&#39;g1&#39;</span>],<span class="st">&#39;.&#39;</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>plt.xlim(<span class="op">-</span><span class="dv">4</span>,<span class="dv">4</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>plt.ylim(<span class="op">-</span><span class="dv">4</span>,<span class="dv">4</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">&#39;autoenc_10.png&#39;</span>)</span></code></pre></div>
<p><img src="autoenc_10.png" /></p>
<p><img src="autoenc_07.png" /></p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">Based on https://github.com/keras-team/keras/blob/master/examples/variational_autoencoder.py</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> keras</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.datasets <span class="im">import</span> mnist</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras <span class="im">import</span> backend <span class="im">as</span> K</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.models <span class="im">import</span> Sequential, Model</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> Input, LSTM, RepeatVector</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers.core <span class="im">import</span> Flatten, Dense, Dropout, Lambda</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.optimizers <span class="im">import</span> SGD, RMSprop, Adam</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras <span class="im">import</span> objectives</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>timesteps <span class="op">=</span> <span class="dv">28</span><span class="op">;</span> input_dim <span class="op">=</span> <span class="dv">28</span><span class="op">;</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>latent_dim <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_lstm_vae(input_dim, </span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    timesteps, </span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    batch_size, </span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    intermediate_dim, </span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    latent_dim,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    epsilon_std<span class="op">=</span><span class="fl">1.</span>):</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> Input(shape<span class="op">=</span>(timesteps, input_dim,))</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (x)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LSTM encoding</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> LSTM(intermediate_dim)(x)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (h)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VAE Z layer</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    z_mean <span class="op">=</span> Dense(latent_dim)(h)</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    z_log_sigma <span class="op">=</span> Dense(latent_dim)(h)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> sampling(args):</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>        z_mean, z_log_sigma <span class="op">=</span> args</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>        epsilon <span class="op">=</span> K.random_normal(shape<span class="op">=</span>(batch_size, latent_dim),</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>                                  mean<span class="op">=</span><span class="fl">0.</span>, stddev<span class="op">=</span>epsilon_std)</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> z_mean <span class="op">+</span> z_log_sigma <span class="op">*</span> epsilon</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> Lambda(sampling, output_shape<span class="op">=</span>(latent_dim,))([z_mean, z_log_sigma])</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (z)</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># decoded LSTM layer</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    decoder_h <span class="op">=</span> LSTM(intermediate_dim, return_sequences<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    decoder_mean <span class="op">=</span> LSTM(input_dim, return_sequences<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    h_decoded <span class="op">=</span> RepeatVector(timesteps)(z)</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (h_decoded)</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>    h_decoded <span class="op">=</span> decoder_h(h_decoded)</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (h_decoded)</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># decoded layer</span></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>    x_decoded_mean <span class="op">=</span> decoder_mean(h_decoded)</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (x_decoded_mean)</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># end-to-end autoencoder</span></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>    vae <span class="op">=</span> Model(x, x_decoded_mean)</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># encoder, from inputs to latent space</span></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>    encoder <span class="op">=</span> Model(x, z_mean)</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># generator, from latent space to reconstructed inputs</span></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>    decoder_input <span class="op">=</span> Input(shape<span class="op">=</span>(latent_dim,))</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (decoder_input)</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>    _h_decoded <span class="op">=</span> RepeatVector(timesteps)(decoder_input)</span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (_h_decoded)</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>    _h_decoded <span class="op">=</span> decoder_h(_h_decoded)</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (_h_decoded)</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>    _x_decoded_mean <span class="op">=</span> decoder_mean(_h_decoded)</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>    generator <span class="op">=</span> Model(decoder_input, _x_decoded_mean)</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> vae_loss(x, x_decoded_mean):</span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>        xent_loss <span class="op">=</span> objectives.mse(x, x_decoded_mean)</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>        kl_loss <span class="op">=</span> <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> K.mean(<span class="dv">1</span> <span class="op">+</span> z_log_sigma <span class="op">-</span> K.square(z_mean) <span class="op">-</span> K.exp(z_log_sigma))</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> xent_loss <span class="op">+</span> kl_loss</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> loss</span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>    vae.<span class="bu">compile</span>(optimizer<span class="op">=</span><span class="st">&#39;rmsprop&#39;</span>, loss<span class="op">=</span>vae_loss)</span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> vae, encoder, generator</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>    (x_train, _), (x_test, _) <span class="op">=</span> mnist.load_data()</span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>    x_train <span class="op">=</span> x_train.astype(<span class="st">&#39;float32&#39;</span>) <span class="op">/</span> <span class="fl">255.</span></span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>    <span class="co">#x_train = x_train[:200]</span></span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>    x_test <span class="op">=</span> x_test.astype(<span class="st">&#39;float32&#39;</span>) <span class="op">/</span> <span class="fl">255.</span></span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>    <span class="co">#x_test = x_test[:200]</span></span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (x_train.shape)</span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (x_test.shape)    </span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> x_train</span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>    vae, enc, gen <span class="op">=</span> create_lstm_vae(input_dim, </span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>        timesteps<span class="op">=</span>timesteps, </span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span>batch_size, </span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>        intermediate_dim<span class="op">=</span>latent_dim,</span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>        latent_dim<span class="op">=</span>latent_dim,</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>        epsilon_std<span class="op">=</span><span class="fl">1.</span>)</span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>    vae.fit(x, x, validation_data<span class="op">=</span>(x_test, x_test), epochs<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a>    vae.save(<span class="st">&#39;mnist_lstm_vae.h5&#39;</span>)</span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a>    enc.save(<span class="st">&#39;mnist_lstm_enc.h5&#39;</span>)</span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a>    gen.save(<span class="st">&#39;mnist_lstm_gen.h5&#39;</span>)</span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a>    <span class="co">#preds = vae.predict(x, batch_size=batch_size)</span></span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mnist_lstm_vae</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>vae, enc, gen <span class="op">=</span> mnist_lstm_vae.create_lstm_vae(mnist_lstm_vae.input_dim, </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    timesteps<span class="op">=</span>mnist_lstm_vae.timesteps, </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span>mnist_lstm_vae.batch_size, </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    intermediate_dim<span class="op">=</span>mnist_lstm_vae.latent_dim,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    latent_dim<span class="op">=</span>mnist_lstm_vae.latent_dim,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    epsilon_std<span class="op">=</span><span class="fl">1.</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>vae.load_weights(<span class="st">&#39;mnist_lstm_vae.h5&#39;</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>enc.load_weights(<span class="st">&#39;mnist_lstm_enc.h5&#39;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> <span class="dv">400</span> <span class="co"># herhangi bir imaji sec</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (tmp.shape)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>x_test_tmp <span class="op">=</span> x_test[idx]</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> vae.predict(x_test_tmp.reshape((<span class="dv">1</span>, <span class="dv">28</span>, <span class="dv">28</span>)))</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>plt.figure()</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>pixels <span class="op">=</span> res.reshape((<span class="dv">28</span>, <span class="dv">28</span>))</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>plt.imshow(pixels)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>plt.gray()</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>plt.imshow(x_test_tmp)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>plt.gray()</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">&#39;autoenc_04.png&#39;</span>)</span></code></pre></div>
<p><img src="autoenc_04.png" /></p>
<p>Gördüğümüz gibi zamansal işlem yaptık ama VAE çok iyi sonuç verdi.
Hatta test imajını daha netleştirdi!</p>
<p>Hasımsal Özkodlayıcı (Adverserial Autoencoder -AA-)</p>
<p>Üretici Hasımsal Ağlar (Generative Adverserial Networks -GAN-)
kavramının özkodlayıcılara uygulanmış hali AA olur.</p>
<p><img src="autoenc_09.png" /></p>
<p>Burada bir kodlayıcı / kodçözücü yapısı var (üst blok) bu yapıdan
kodlanmış ara tabaka <span class="math inline">\(z \sim q(z)\)</span>
“kötü’’ örnekler çekilip <span class="math inline">\(p(z)\)</span>’den
gelen”iyi’’ örnekler ile birleştiriliyor ve ayırdedici yine bu iki grup
arasında ayırım yapmayı öğreniyor. Bu durumda üst bloktaki kodçözücü
GAN’deki üretici gibi olur, ona dönüşür bir bakıma, çünkü öyle iyi
üretim yapmaya çalışacaktır ki <span class="math inline">\(p(z)\)</span>
gürültüsü ile onun aldığı kodlanmış tabaka verisi ayiredilemez hale
gelmelidir. Tabii ki üst soldaki kodlayıcı bu ara tabakaya o şekilde
temsili veri üretmeye çalışacaktır, bu arada kodlayıcı / kodçözücü
yapısı da eğitilmiş olur. Yani <span class="math inline">\(z\)</span>
bir anlamda alt soldaki gerçek gürültüye yaklaşır, bu gürültüden sayı
üretebilir hale geliriz, bu klasik GAN, ayrıca bu “kodlanmış’’ gürültüyü
üreten kodlayıcı / kodçözücü tabaka da ayrı bir şekilde kendini optimize
eder ve kodlama işini yapar hale gelir.</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import os</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># os.environ[&quot;THEANO_FLAGS&quot;] = &quot;mode=FAST_COMPILE,device=cpu,floatX=float32&quot;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># This line allows mpl to run with no DISPLAY defined</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> Dense, Reshape, Flatten, Input, merge</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.models <span class="im">import</span> Sequential, Model</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.optimizers <span class="im">import</span> Adam</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> legacy <span class="im">import</span> l1l2</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> keras.backend <span class="im">as</span> K</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd, os</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> adversarial_model <span class="im">import</span> AdversarialModel</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> adversarial_utils <span class="im">import</span> fix_names, n_choice, normal_latent_sampling</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> adversarial_optimizers <span class="im">import</span> AdversarialOptimizerSimultaneous</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> LeakyReLU, Activation</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.datasets <span class="im">import</span> mnist</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mnist_process(x):</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> x.astype(np.float32) <span class="op">/</span> <span class="fl">255.0</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mnist_data():</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    (xtrain, ytrain), (xtest, ytest) <span class="op">=</span> mnist.load_data()</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mnist_process(xtrain), mnist_process(xtest)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model_generator(latent_dim, input_shape,</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>                    hidden_dim<span class="op">=</span><span class="dv">512</span>,</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>                    reg<span class="op">=</span><span class="kw">lambda</span>: l1l2(<span class="fl">1e-7</span>, <span class="dv">0</span>)):</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Sequential([</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>        Dense(hidden_dim, name<span class="op">=</span><span class="st">&quot;generator_h1&quot;</span>,</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>              input_dim<span class="op">=</span>latent_dim,</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>              W_regularizer<span class="op">=</span>reg()),</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>        LeakyReLU(<span class="fl">0.2</span>),</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>        Dense(hidden_dim,</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>              name<span class="op">=</span><span class="st">&quot;generator_h2&quot;</span>,</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>              W_regularizer<span class="op">=</span>reg()),</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>        LeakyReLU(<span class="fl">0.2</span>),</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>        Dense(np.prod(input_shape),</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>              name<span class="op">=</span><span class="st">&quot;generator_x_flat&quot;</span>,</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>              W_regularizer<span class="op">=</span>reg()),</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>        Activation(<span class="st">&#39;sigmoid&#39;</span>),</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>        Reshape(input_shape, name<span class="op">=</span><span class="st">&quot;generator_x&quot;</span>)],</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">&quot;generator&quot;</span>)</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model_encoder(latent_dim, input_shape,</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>                  hidden_dim<span class="op">=</span><span class="dv">512</span>,</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>                  reg<span class="op">=</span><span class="kw">lambda</span>: l1l2(<span class="fl">1e-7</span>, <span class="dv">0</span>)):</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> Input(input_shape, name<span class="op">=</span><span class="st">&quot;x&quot;</span>)</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> Flatten()(x)</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> Dense(hidden_dim, name<span class="op">=</span><span class="st">&quot;encoder_h1&quot;</span>, W_regularizer<span class="op">=</span>reg())(h)</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> LeakyReLU(<span class="fl">0.2</span>)(h)</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> Dense(hidden_dim, name<span class="op">=</span><span class="st">&quot;encoder_h2&quot;</span>, W_regularizer<span class="op">=</span>reg())(h)</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> LeakyReLU(<span class="fl">0.2</span>)(h)</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> Dense(latent_dim, name<span class="op">=</span><span class="st">&quot;encoder_mu&quot;</span>, W_regularizer<span class="op">=</span>reg())(h)</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>    log_sigma_sq <span class="op">=</span> Dense(latent_dim, name<span class="op">=</span><span class="st">&quot;encoder_log_sigma_sq&quot;</span>, W_regularizer<span class="op">=</span>reg())(h)</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> merge([mu, log_sigma_sq], mode<span class="op">=</span><span class="kw">lambda</span> p: p[<span class="dv">0</span>] <span class="op">+</span> K.random_normal(K.shape(p[<span class="dv">0</span>])) <span class="op">*</span> K.exp(p[<span class="dv">1</span>] <span class="op">/</span> <span class="dv">2</span>),</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>              output_shape<span class="op">=</span><span class="kw">lambda</span> p: p[<span class="dv">0</span>])</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Model(x, z, name<span class="op">=</span><span class="st">&quot;encoder&quot;</span>)</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model_discriminator(latent_dim, output_dim<span class="op">=</span><span class="dv">1</span>, hidden_dim<span class="op">=</span><span class="dv">512</span>,</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>                        reg<span class="op">=</span><span class="kw">lambda</span>: l1l2(<span class="fl">1e-7</span>, <span class="fl">1e-7</span>)):</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> Input((latent_dim,))</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> z</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> Dense(hidden_dim, name<span class="op">=</span><span class="st">&quot;discriminator_h1&quot;</span>, W_regularizer<span class="op">=</span>reg())(h)</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> LeakyReLU(<span class="fl">0.2</span>)(h)</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> Dense(hidden_dim, name<span class="op">=</span><span class="st">&quot;discriminator_h2&quot;</span>, W_regularizer<span class="op">=</span>reg())(h)</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> LeakyReLU(<span class="fl">0.2</span>)(h)</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> Dense(output_dim, name<span class="op">=</span><span class="st">&quot;discriminator_y&quot;</span>, activation<span class="op">=</span><span class="st">&quot;sigmoid&quot;</span>, W_regularizer<span class="op">=</span>reg())(h)</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Model(z, y)</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train(adversarial_optimizer):</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># z \in R^100</span></span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>    latent_dim <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># x \in R^{28x28}</span></span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>    input_shape <span class="op">=</span> (<span class="dv">28</span>, <span class="dv">28</span>)</span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># generator (z -&gt; x)</span></span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>    generator <span class="op">=</span> model_generator(latent_dim, input_shape)</span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># encoder (x -&gt;z)</span></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>    encoder <span class="op">=</span> model_encoder(latent_dim, input_shape)</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># autoencoder (x -&gt; x&#39;)</span></span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>    autoencoder <span class="op">=</span> Model(encoder.inputs, generator(encoder(encoder.inputs)))</span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># discriminator (z -&gt; y)</span></span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>    discriminator <span class="op">=</span> model_discriminator(latent_dim)</span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># assemple AAE</span></span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> encoder.inputs[<span class="dv">0</span>]</span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> encoder(x)</span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>    xpred <span class="op">=</span> generator(z)</span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>    zreal <span class="op">=</span> normal_latent_sampling((latent_dim,))(x)</span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>    yreal <span class="op">=</span> discriminator(zreal)</span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>    yfake <span class="op">=</span> discriminator(z)</span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>    aae <span class="op">=</span> Model(x, fix_names([xpred, yfake, yreal], [<span class="st">&quot;xpred&quot;</span>, <span class="st">&quot;yfake&quot;</span>, <span class="st">&quot;yreal&quot;</span>]))</span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print summary of models</span></span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>    generator.summary()</span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>    encoder.summary()</span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>    discriminator.summary()</span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>    autoencoder.summary()</span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># build adversarial model</span></span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a>    generative_params <span class="op">=</span> generator.trainable_weights <span class="op">+</span> encoder.trainable_weights</span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> AdversarialModel(base_model<span class="op">=</span>aae,</span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a>                             player_params<span class="op">=</span>[generative_params, discriminator.trainable_weights],</span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a>                             player_names<span class="op">=</span>[<span class="st">&quot;generator&quot;</span>, <span class="st">&quot;discriminator&quot;</span>])</span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a>    model.adversarial_compile(adversarial_optimizer<span class="op">=</span>adversarial_optimizer,</span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a>                              player_optimizers<span class="op">=</span>[Adam(<span class="fl">1e-4</span>, decay<span class="op">=</span><span class="fl">1e-4</span>), Adam(<span class="fl">1e-3</span>, decay<span class="op">=</span><span class="fl">1e-4</span>)],</span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a>                              loss<span class="op">=</span>{<span class="st">&quot;yfake&quot;</span>: <span class="st">&quot;binary_crossentropy&quot;</span>, <span class="st">&quot;yreal&quot;</span>: <span class="st">&quot;binary_crossentropy&quot;</span>,</span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&quot;xpred&quot;</span>: <span class="st">&quot;mean_squared_error&quot;</span>},</span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a>                              player_compile_kwargs<span class="op">=</span>[{<span class="st">&quot;loss_weights&quot;</span>: {<span class="st">&quot;yfake&quot;</span>: <span class="fl">1e-2</span>, <span class="st">&quot;yreal&quot;</span>: <span class="fl">1e-2</span>, <span class="st">&quot;xpred&quot;</span>: <span class="dv">1</span>}}] <span class="op">*</span> <span class="dv">2</span>)</span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a>    <span class="co"># load mnist data</span></span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a>    xtrain, xtest <span class="op">=</span> mnist_data()</span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># callback for image grid of generated samples</span></span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generator_sampler():</span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a>        zsamples <span class="op">=</span> np.random.normal(size<span class="op">=</span>(<span class="dv">10</span> <span class="op">*</span> <span class="dv">10</span>, latent_dim))</span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> generator.predict(zsamples).reshape((<span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">28</span>, <span class="dv">28</span>))</span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># callback   for image grid of autoencoded samples</span></span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> autoencoder_sampler():</span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a>        xsamples <span class="op">=</span> n_choice(xtest, <span class="dv">10</span>)</span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a>        xrep <span class="op">=</span> np.repeat(xsamples, <span class="dv">9</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a>        xgen <span class="op">=</span> autoencoder.predict(xrep).reshape((<span class="dv">10</span>, <span class="dv">9</span>, <span class="dv">28</span>, <span class="dv">28</span>))</span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a>        xsamples <span class="op">=</span> xsamples.reshape((<span class="dv">10</span>, <span class="dv">1</span>, <span class="dv">28</span>, <span class="dv">28</span>))</span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a>        samples <span class="op">=</span> np.concatenate((xsamples, xgen), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> samples</span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a>    <span class="co"># train network</span></span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a>    <span class="co"># generator, discriminator; pred, yfake, yreal</span></span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> xtrain.shape[<span class="dv">0</span>]</span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> [xtrain, np.ones((n, <span class="dv">1</span>)), np.zeros((n, <span class="dv">1</span>)), xtrain, np.zeros((n, <span class="dv">1</span>)), np.ones((n, <span class="dv">1</span>))]</span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a>    ntest <span class="op">=</span> xtest.shape[<span class="dv">0</span>]</span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a>    ytest <span class="op">=</span> [xtest, np.ones((ntest, <span class="dv">1</span>)), np.zeros((ntest, <span class="dv">1</span>)), xtest, np.zeros((ntest, <span class="dv">1</span>)), np.ones((ntest, <span class="dv">1</span>))]</span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a>    history <span class="op">=</span> model.fit(x<span class="op">=</span>xtrain, y<span class="op">=</span>y, validation_data<span class="op">=</span>(xtest, ytest), nb_epoch<span class="op">=</span><span class="dv">100</span>, batch_size<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-142"><a href="#cb14-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-143"><a href="#cb14-143" aria-hidden="true" tabindex="-1"></a>    <span class="co"># save model</span></span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a>    encoder.save(<span class="st">&quot;aae-norm-encoder.h5&quot;</span>)</span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a>    generator.save(<span class="st">&quot;aae-norm-generator.h5&quot;</span>)</span>
<span id="cb14-146"><a href="#cb14-146" aria-hidden="true" tabindex="-1"></a>    discriminator.save(<span class="st">&quot;aae-norm-discriminator.h5&quot;</span>)</span>
<span id="cb14-147"><a href="#cb14-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a>    train(AdversarialOptimizerSimultaneous())</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> aae_normal</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>latent_dim <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>input_shape <span class="op">=</span> (<span class="dv">28</span>, <span class="dv">28</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>encoder <span class="op">=</span> aae_normal.model_encoder(latent_dim, input_shape)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>encoder.load_weights(<span class="st">&#39;aae-norm-encoder.h5&#39;</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>generator <span class="op">=</span> aae_normal.model_generator(latent_dim, input_shape)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>generator.load_weights(<span class="st">&#39;aae-norm-generator.h5&#39;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> <span class="dv">100</span> <span class="co"># herhangi bir imaji sec</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (x_test[idx, :].shape)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> encoder.predict(x_test[idx, :].reshape(<span class="dv">1</span>,<span class="dv">28</span>,<span class="dv">28</span>))</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span> (res.shape)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>pixels <span class="op">=</span> generator.predict(res)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>pixels <span class="op">=</span> pixels.reshape((<span class="dv">28</span>, <span class="dv">28</span>))</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>plt.imshow(pixels)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>plt.gray()</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">&#39;autoenc_05.png&#39;</span>)</span></code></pre></div>
<p><img src="autoenc_05.png" /></p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import os</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># os.environ[&quot;THEANO_FLAGS&quot;] = &quot;mode=FAST_COMPILE,device=cpu,floatX=float32&quot;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># This line allows mpl to run with no DISPLAY defined</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> Dense, Reshape, Flatten, Input, merge</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.models <span class="im">import</span> Sequential, Model</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.optimizers <span class="im">import</span> Adam</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> legacy <span class="im">import</span> l1l2</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> keras.backend <span class="im">as</span> K</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.datasets <span class="im">import</span> mnist</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np, os, pandas <span class="im">as</span> pd</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> adversarial_model <span class="im">import</span> AdversarialModel</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> adversarial_utils <span class="im">import</span> fix_names, n_choice, normal_latent_sampling</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> adversarial_optimizers <span class="im">import</span> AdversarialOptimizerSimultaneous</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.layers <span class="im">import</span> LeakyReLU, Activation, LSTM, GRU, RepeatVector</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mnist_process(x):</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> x.astype(np.float32) <span class="op">/</span> <span class="fl">255.0</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mnist_data():</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    (xtrain, ytrain), (xtest, ytest) <span class="op">=</span> mnist.load_data()</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mnist_process(xtrain), mnist_process(xtest)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>activation<span class="op">=</span><span class="st">&#39;relu&#39;</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model_generator(latent_dim, input_shape,</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>                    hidden_dim<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>                    reg<span class="op">=</span><span class="kw">lambda</span>: l1l2(<span class="fl">1e-7</span>, <span class="dv">0</span>)):</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Sequential([</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>        Dense(np.prod(input_shape), activation<span class="op">=</span>activation,</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>              name<span class="op">=</span><span class="st">&quot;generator_h1&quot;</span>, input_dim<span class="op">=</span>latent_dim,</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>              W_regularizer<span class="op">=</span>reg()),</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>        Reshape(input_shape, name<span class="op">=</span><span class="st">&quot;generator_x&quot;</span>),</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>        GRU(latent_dim,return_sequences<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>        GRU(<span class="dv">28</span>,return_sequences<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">&quot;generator&quot;</span>)</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model_encoder(latent_dim, input_shape,</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>                  hidden_dim<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>                  reg<span class="op">=</span><span class="kw">lambda</span>: l1l2(<span class="fl">1e-7</span>, <span class="dv">0</span>)):</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> Input(input_shape, name<span class="op">=</span><span class="st">&quot;x&quot;</span>)</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> GRU(hidden_dim, return_sequences<span class="op">=</span><span class="va">True</span>)(x)</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> GRU(hidden_dim)(h)</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> Dense(hidden_dim, activation<span class="op">=</span>activation,</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>              name<span class="op">=</span><span class="st">&quot;encoder_h3&quot;</span>,</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>              W_regularizer<span class="op">=</span>reg())(h)    </span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> Dense(latent_dim, name<span class="op">=</span><span class="st">&quot;encoder_mu&quot;</span>, W_regularizer<span class="op">=</span>reg())(h)</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>    log_sigma_sq <span class="op">=</span> Dense(latent_dim, name<span class="op">=</span><span class="st">&quot;encoder_log_sigma_sq&quot;</span>,</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>                         W_regularizer<span class="op">=</span>reg())(h)</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> merge([mu, log_sigma_sq],</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>              mode<span class="op">=</span><span class="kw">lambda</span> p: p[<span class="dv">0</span>] <span class="op">+</span> K.random_normal(K.shape(p[<span class="dv">0</span>])) <span class="op">*</span> K.exp(p[<span class="dv">1</span>] <span class="op">/</span> <span class="dv">2</span>),</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>              output_shape<span class="op">=</span><span class="kw">lambda</span> p: p[<span class="dv">0</span>])</span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Model(x, z, name<span class="op">=</span><span class="st">&quot;encoder&quot;</span>)</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model_discriminator(latent_dim, output_dim<span class="op">=</span><span class="dv">1</span>, hidden_dim<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>                        reg<span class="op">=</span><span class="kw">lambda</span>: l1l2(<span class="fl">1e-7</span>, <span class="fl">1e-7</span>)):</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> Input((latent_dim,))</span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> z</span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> Dense(hidden_dim, name<span class="op">=</span><span class="st">&quot;discriminator_h1&quot;</span>, W_regularizer<span class="op">=</span>reg())(h)</span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> LeakyReLU(<span class="fl">0.2</span>)(h)</span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> Dense(hidden_dim, name<span class="op">=</span><span class="st">&quot;discriminator_h2&quot;</span>, W_regularizer<span class="op">=</span>reg())(h)</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>    h <span class="op">=</span> LeakyReLU(<span class="fl">0.2</span>)(h)</span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> Dense(output_dim, name<span class="op">=</span><span class="st">&quot;discriminator_y&quot;</span>, activation<span class="op">=</span><span class="st">&quot;sigmoid&quot;</span>, W_regularizer<span class="op">=</span>reg())(h)</span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Model(z, y)</span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> example_aae(adversarial_optimizer):</span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># z \in R^100</span></span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>    latent_dim <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># x \in R^{28x28}</span></span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>    input_shape <span class="op">=</span> (<span class="dv">28</span>, <span class="dv">28</span>)</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># generator (z -&gt; x)</span></span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>    generator <span class="op">=</span> model_generator(latent_dim, input_shape)</span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># encoder (x -&gt;z)</span></span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a>    encoder <span class="op">=</span> model_encoder(latent_dim, input_shape)</span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># autoencoder (x -&gt; x&#39;)</span></span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (encoder.inputs)</span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a>    e <span class="op">=</span> encoder(encoder.inputs)</span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a>    g <span class="op">=</span> generator(e)</span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>    autoencoder <span class="op">=</span> Model(encoder.inputs, g)</span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># discriminator (z -&gt; y)</span></span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a>    discriminator <span class="op">=</span> model_discriminator(latent_dim)</span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># assemple AAE</span></span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> encoder.inputs[<span class="dv">0</span>]</span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a>    z <span class="op">=</span> encoder(x)</span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a>    xpred <span class="op">=</span> generator(z)</span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a>    zreal <span class="op">=</span> normal_latent_sampling((latent_dim,))(x)</span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a>    yreal <span class="op">=</span> discriminator(zreal)</span>
<span id="cb17-99"><a href="#cb17-99" aria-hidden="true" tabindex="-1"></a>    yfake <span class="op">=</span> discriminator(z)</span>
<span id="cb17-100"><a href="#cb17-100" aria-hidden="true" tabindex="-1"></a>    aae <span class="op">=</span> Model(x, fix_names([xpred, yfake, yreal], [<span class="st">&quot;xpred&quot;</span>, <span class="st">&quot;yfake&quot;</span>, <span class="st">&quot;yreal&quot;</span>]))</span>
<span id="cb17-101"><a href="#cb17-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-102"><a href="#cb17-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print summary of models</span></span>
<span id="cb17-103"><a href="#cb17-103" aria-hidden="true" tabindex="-1"></a>    generator.summary()</span>
<span id="cb17-104"><a href="#cb17-104" aria-hidden="true" tabindex="-1"></a>    encoder.summary()</span>
<span id="cb17-105"><a href="#cb17-105" aria-hidden="true" tabindex="-1"></a>    discriminator.summary()</span>
<span id="cb17-106"><a href="#cb17-106" aria-hidden="true" tabindex="-1"></a>    autoencoder.summary()</span>
<span id="cb17-107"><a href="#cb17-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-108"><a href="#cb17-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># build adversarial model</span></span>
<span id="cb17-109"><a href="#cb17-109" aria-hidden="true" tabindex="-1"></a>    generative_params <span class="op">=</span> generator.trainable_weights <span class="op">+</span> encoder.trainable_weights</span>
<span id="cb17-110"><a href="#cb17-110" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> AdversarialModel(base_model<span class="op">=</span>aae,</span>
<span id="cb17-111"><a href="#cb17-111" aria-hidden="true" tabindex="-1"></a>                             player_params<span class="op">=</span>[generative_params, discriminator.trainable_weights],</span>
<span id="cb17-112"><a href="#cb17-112" aria-hidden="true" tabindex="-1"></a>                             player_names<span class="op">=</span>[<span class="st">&quot;generator&quot;</span>, <span class="st">&quot;discriminator&quot;</span>])</span>
<span id="cb17-113"><a href="#cb17-113" aria-hidden="true" tabindex="-1"></a>    model.adversarial_compile(adversarial_optimizer<span class="op">=</span>adversarial_optimizer,</span>
<span id="cb17-114"><a href="#cb17-114" aria-hidden="true" tabindex="-1"></a>                              player_optimizers<span class="op">=</span>[Adam(<span class="fl">1e-4</span>, decay<span class="op">=</span><span class="fl">1e-4</span>), Adam(<span class="fl">1e-3</span>, decay<span class="op">=</span><span class="fl">1e-4</span>)],</span>
<span id="cb17-115"><a href="#cb17-115" aria-hidden="true" tabindex="-1"></a>                              loss<span class="op">=</span>{<span class="st">&quot;yfake&quot;</span>: <span class="st">&quot;binary_crossentropy&quot;</span>, <span class="st">&quot;yreal&quot;</span>: <span class="st">&quot;binary_crossentropy&quot;</span>,</span>
<span id="cb17-116"><a href="#cb17-116" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">&quot;xpred&quot;</span>: <span class="st">&quot;mean_squared_error&quot;</span>},</span>
<span id="cb17-117"><a href="#cb17-117" aria-hidden="true" tabindex="-1"></a>                              player_compile_kwargs<span class="op">=</span>[{<span class="st">&quot;loss_weights&quot;</span>: {<span class="st">&quot;yfake&quot;</span>: <span class="fl">1e-2</span>, <span class="st">&quot;yreal&quot;</span>: <span class="fl">1e-2</span>, <span class="st">&quot;xpred&quot;</span>: <span class="dv">1</span>}}] <span class="op">*</span> <span class="dv">2</span>)</span>
<span id="cb17-118"><a href="#cb17-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-119"><a href="#cb17-119" aria-hidden="true" tabindex="-1"></a>    <span class="co"># load mnist data</span></span>
<span id="cb17-120"><a href="#cb17-120" aria-hidden="true" tabindex="-1"></a>    xtrain, xtest <span class="op">=</span> mnist_data()</span>
<span id="cb17-121"><a href="#cb17-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-122"><a href="#cb17-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># callback for image grid of generated samples</span></span>
<span id="cb17-123"><a href="#cb17-123" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generator_sampler():</span>
<span id="cb17-124"><a href="#cb17-124" aria-hidden="true" tabindex="-1"></a>        zsamples <span class="op">=</span> np.random.normal(size<span class="op">=</span>(<span class="dv">10</span> <span class="op">*</span> <span class="dv">10</span>, latent_dim))</span>
<span id="cb17-125"><a href="#cb17-125" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> generator.predict(zsamples).reshape((<span class="dv">10</span>, <span class="dv">10</span>, <span class="dv">28</span>, <span class="dv">28</span>))</span>
<span id="cb17-126"><a href="#cb17-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-127"><a href="#cb17-127" aria-hidden="true" tabindex="-1"></a>    <span class="co"># callback   for image grid of autoencoded samples</span></span>
<span id="cb17-128"><a href="#cb17-128" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> autoencoder_sampler():</span>
<span id="cb17-129"><a href="#cb17-129" aria-hidden="true" tabindex="-1"></a>        xsamples <span class="op">=</span> n_choice(xtest, <span class="dv">10</span>)</span>
<span id="cb17-130"><a href="#cb17-130" aria-hidden="true" tabindex="-1"></a>        xrep <span class="op">=</span> np.repeat(xsamples, <span class="dv">9</span>, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb17-131"><a href="#cb17-131" aria-hidden="true" tabindex="-1"></a>        xgen <span class="op">=</span> autoencoder.predict(xrep).reshape((<span class="dv">10</span>, <span class="dv">9</span>, <span class="dv">28</span>, <span class="dv">28</span>))</span>
<span id="cb17-132"><a href="#cb17-132" aria-hidden="true" tabindex="-1"></a>        xsamples <span class="op">=</span> xsamples.reshape((<span class="dv">10</span>, <span class="dv">1</span>, <span class="dv">28</span>, <span class="dv">28</span>))</span>
<span id="cb17-133"><a href="#cb17-133" aria-hidden="true" tabindex="-1"></a>        samples <span class="op">=</span> np.concatenate((xsamples, xgen), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb17-134"><a href="#cb17-134" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> samples</span>
<span id="cb17-135"><a href="#cb17-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-136"><a href="#cb17-136" aria-hidden="true" tabindex="-1"></a>    <span class="co"># train network</span></span>
<span id="cb17-137"><a href="#cb17-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># generator, discriminator; pred, yfake, yreal</span></span>
<span id="cb17-138"><a href="#cb17-138" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> xtrain.shape[<span class="dv">0</span>]</span>
<span id="cb17-139"><a href="#cb17-139" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> [xtrain, np.ones((n, <span class="dv">1</span>)), np.zeros((n, <span class="dv">1</span>)), xtrain, np.zeros((n, <span class="dv">1</span>)), np.ones((n, <span class="dv">1</span>))]</span>
<span id="cb17-140"><a href="#cb17-140" aria-hidden="true" tabindex="-1"></a>    ntest <span class="op">=</span> xtest.shape[<span class="dv">0</span>]</span>
<span id="cb17-141"><a href="#cb17-141" aria-hidden="true" tabindex="-1"></a>    ytest <span class="op">=</span> [xtest, np.ones((ntest, <span class="dv">1</span>)), np.zeros((ntest, <span class="dv">1</span>)), xtest, np.zeros((ntest, <span class="dv">1</span>)), np.ones((ntest, <span class="dv">1</span>))]</span>
<span id="cb17-142"><a href="#cb17-142" aria-hidden="true" tabindex="-1"></a>    history <span class="op">=</span> model.fit(x<span class="op">=</span>xtrain, y<span class="op">=</span>y, validation_data<span class="op">=</span>(xtest, ytest), nb_epoch<span class="op">=</span><span class="dv">50</span>, batch_size<span class="op">=</span><span class="dv">32</span>)</span>
<span id="cb17-143"><a href="#cb17-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-144"><a href="#cb17-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># save model</span></span>
<span id="cb17-145"><a href="#cb17-145" aria-hidden="true" tabindex="-1"></a>    encoder.save(<span class="st">&quot;aae-lstm-encoder.h5&quot;</span>)</span>
<span id="cb17-146"><a href="#cb17-146" aria-hidden="true" tabindex="-1"></a>    generator.save(<span class="st">&quot;aae-lstm-generator.h5&quot;</span>)</span>
<span id="cb17-147"><a href="#cb17-147" aria-hidden="true" tabindex="-1"></a>    discriminator.save(<span class="st">&quot;aae-lstm-discriminator.h5&quot;</span>)</span>
<span id="cb17-148"><a href="#cb17-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-149"><a href="#cb17-149" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb17-150"><a href="#cb17-150" aria-hidden="true" tabindex="-1"></a>    example_aae(AdversarialOptimizerSimultaneous())</span></code></pre></div>
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> aae_lstm</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>latent_dim <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>input_shape <span class="op">=</span> (<span class="dv">28</span>, <span class="dv">28</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>encoder <span class="op">=</span> aae_lstm.model_encoder(latent_dim, input_shape)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>encoder.load_weights(<span class="st">&#39;aae-lstm-encoder.h5&#39;</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>generator <span class="op">=</span> aae_lstm.model_generator(latent_dim, input_shape)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>generator.load_weights(<span class="st">&#39;aae-lstm-generator.h5&#39;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> <span class="dv">1030</span> <span class="co"># herhangi bir imaji sec</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> encoder.predict(x_test[idx, :].reshape(<span class="dv">1</span>, <span class="dv">28</span>,<span class="dv">28</span>))</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>pixels <span class="op">=</span> generator.predict(res)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>pixels <span class="op">=</span> pixels.reshape((<span class="dv">28</span>, <span class="dv">28</span>))</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>plt.imshow(pixels)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>plt.gray()</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">&#39;autoenc_08.png&#39;</span>)</span></code></pre></div>
<p><img src="autoenc_08.png" /></p>
<p>Kaynaklar</p>
<p>[1] <a
href="https://blog.keras.io/building-autoencoders-in-keras.html">https://blog.keras.io/building-autoencoders-in-keras.html</a></p>
<p>[2] <em>Adverserial Autoencoder Keras</em>, <a
href="https://github.com/bstriner/keras-adversarial/blob/master/examples/example_aae.py">https://github.com/bstriner/keras-adversarial/blob/master/examples/example_aae.py</a></p>
<p>[3] <a
href="https://towardsdatascience.com/intuitively-understanding-variational-autoencoders-1bfe67eb5daf">https://towardsdatascience.com/intuitively-understanding-variational-autoencoders-1bfe67eb5daf</a></p>
<p>[4] <a
href="https://hsaghir.github.io/data_science/denoising-vs-variational-autoencoder/">https://hsaghir.github.io/data_science/denoising-vs-variational-autoencoder/</a></p>
<p>[5] Doersch, Tutorial on Variational Autoencoders, <a
href="https://arxiv.org/pdf/1606.05908.pdf">https://arxiv.org/pdf/1606.05908.pdf</a></p>
<p>[6] Goodfellow, Adversarial Autoencoders, <a
href="https://arxiv.org/pdf/1511.05644.pdf">https://arxiv.org/pdf/1511.05644.pdf</a></p>
<p>[7] What is Adversarial Autoencoder?, <a
href="https://www.quora.com/What-is-Adversarial-Autoencoder">https://www.quora.com/What-is-Adversarial-Autoencoder</a></p>
<p>[8] <a
href="http://www.inference.vc/adversarial-autoencoders/">http://www.inference.vc/adversarial-autoencoders/</a></p>
<p>
  <a href="..">Yukarı</a>
</p>
</body>
</html>
