<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script type="text/x-mathjax-config">
    MathJax.Hub.Register.StartupHook("TeX Jax Ready",function () {
      MathJax.Hub.Insert(MathJax.InputJax.TeX.Definitions.macros,{
        cancel: ["Extension","cancel"], cancelto: ["Extension","cancel"]
      });
    });
    </script>  
   
  <title>Derin Öğrenme ile Go Oyununu Oynamak, DeepMind AlphaGo Zero</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<div id="header">
</div>
<h1
id="derin-öğrenme-ile-go-oyununu-oynamak-deepmind-alphago-zero">Derin
Öğrenme ile Go Oyununu Oynamak, DeepMind AlphaGo Zero</h1>
<p>Yapay Zeka alanındaki heyecan verici ilerlemelerden biri Google
DeepMind şirketinin AlphaGo programının 17 kez Go şampiyonu olmuş Lee
Sedol’u yenmesiydi. Fakat DeepMind orada durmadı, mimariyi geliştirerek
AlphaGo’yu 100-0 yenecek AlphaGo Zero’yu geliştirdi! Yeni mimarinin
ilginç tarafı YZ’nin hiç dış veriye ihtiyaç duymadan eğitilmiş olması.
AGZ sıfır kabiliyet ile başlıyor (clean slate), ve kendisiyle oynaya
oynaya Go şampiyonlarını yenecek hale geliyor. Bu ve ek ilerlemeleri bu
yazıda paylaşıyoruz.</p>
<p>Mimari</p>
<p>Genel olarak AG ve AGZ’nin benzer bazı özellikleri var. Bunlardan
ilki Monte Carlo Ağaç Aramasının (Monte Carlo Tree Search -MCTS-) bir
derin YSA ile genişletilerek kabiliyetinin ilerletilmiş olması. MCTS
konusunu işledik, herhangi bir tahta pozisyonundan başlayarak simülasyon
yapılır, ve kazanç / kayıp verisi yukarı alınarak karar mekanizması için
kullanılır. Fakat simülasyon yapılırken ve her tahta pozisyonundan hamle
seçenekleri üretilirken ne kadar derine inilecek? Oyun bitene kadar
inilirse bu özellikle Go gibi bir oyunda çok derin ve geniş bir ağaç
ortaya çıkartabilir, bilgisayarlar performans açısından böyle bir ağaçla
zorlanırlar. Çözüm belli bir tahtaya bakarak o oyunun kazanılıp
kazanılmayacağı hakkında “sezgisel’’ bir karar verebilmek. Bu işi örüntü
tanıma üzerinden YSA çok güzel yapabilir. Önceden (kendisiyle oynarken)
elde edilen oyun verisine bakarak, tahta pozisyonları ve o oyunun
kazanılıp kazanılmadığı verisiyle eğitilen”değer YSA’sı’’ artık yeni bir
tahtayı görünce o durumun kazanç şansının olup olmadığını -1,+1 arasında
bir değer ile hesaplayabilir. Bu durumda MCTS’in herhangi bir dalda
oyunu sonuna kadar simüle etmesine gerek yoktur, belli bir seviye sonra
durup YSA’ya kazanç şansını sorar, bu değeri kullanır.</p>
<p>İkinci özellik bir ilke / siyaset / strateji YSA’sı kullanmak, ilke
YSA’sı bir tahtayı girdi olarak alıp, yapılabilecek tüm hamleler için
bir kazanç olasılığı üretebilir, ilke YSA’sin çıktısı potansiyel olarak
tüm tahta hücreleri olabilir [1,3]. MCTS bu çıktıları kazanma olasılığı
daha yüksek olan hamle ağaç dallarını simüle etmek için
kullanacaktır.</p>
<p>Yazının geri kalanında 9x9 Go boyutlarını referans alacağız, AG ve
AGZ 19x19 oyunu üzerinde işliyor.</p>
<p><img src="go_02.jpg" /></p>
<p>Bir not düşelim, YSA “bir tahtayı girdi alıyor’’ dedik ama girdi
verisi oldukca zenginleştirilmiş halde, sadece (9,9) boyutunda tek bir
tahta değil, (9,9,17) boyutunda yani 17 katmanlı bir veri”balyası’’. Bu
balyayı hazırlamak için herhangi bir oyun anında tahtaya bakılır, her
renk için (siyah/beyaz) 8 katman yaratılır, bu katmanlardan biri o
rengin o andaki tahtadaki pozisyonu, diğer 7’si hemen önceki 7 adımdaki
aynı rengin pozisyonları, aynı şekilde diğer renk için 8 katman, ve ek
bir katman sıranın kimde olduğu. Tüm bunlar istiflenerek toplam 17
katman yaratılır. Herhangi bir anda oyunun durumu bu tensor üzerinden
belirtilir. Verinin bu şekilde zenginleştirilmesinin sebebi herhalde
zamansal bağlantıları yakalamaya uğraşmak.</p>
<p><img src="go_01.png" /></p>
<p>AlphaGo Zero</p>
<p>AGZ’nin yaptığı ilerlemeler ise şunlar [3]: AlphaGo değer ve ilke
için iki ayrı ağ kullanıyordu. AGZ’de değer ve ilke YZ’leri
birleştirilerek tek bir YSA ile iki çıktı üretilmesi sağlanıyor, bu
yapıya esprili bir şekilde “iki başlı canavar (two-headed monster)’’
ismi de veriliyor. Bu mimari biraz garip gelebilir, çünkü çoğu
uygulamada genellikle tek bir çıktı kullanılır, mesela bir resimde kedi
olup olmadığını tahmin edecek bir YZ tek bir ikisel çıktı ile bunu
yapabilir, ya da resmin belli kategorilere ait olup olmadığı tek bir
vektör çıktısı ile, bu vektörde obje olasılıkları vardır. Fakat biraz
düşününce iki farklı çıktılı yapının niye işlediğini anlayabiliriz,
sonuçta YZ bir fonksiyonu yaklaşık olarak temsil etmeye çabalar, eğitim
sırasında kafa #1 fonksiyonu bir tahmin üretir, ve eğitim o kafanın
yaptığı tahmine sonuç veren parametreleri günceller, aynı şekilde kafa
#2 için düzeltme yapılır.</p>
<p><img src="go_03.png" /></p>
<p>İkinci bir AGZ ilerlemesi artıksal ağ (residual network) adı verilen
bir derin YSA yapısı kullanmak. Artıksal ağlar pür evrişimsel ağların
daha gelişmiş hali, bu yapılarda evrişimsel ağda bölge atlaması
yapılarak sonraki bölgelere direk / kısayol bağlantıları koyuluyor [6].
Örnek bir yapı altta,</p>
<p><img src="resnet34.png" /></p>
<p>Üçüncü ilerleme ise AGZ’nin kendisine karşı oynayarak kendini
eğitmesi (AG için başkaların oynadığı oyunların kayıtları kullanıldı).
DeepMind bilimcileri araştırmaları sırasında şunu anladılar: hangi baz
mimariyle başlarsak başlayalım, MCTS onu daha iyileştirir. Bu durumda
herhangi bir YZ alınır ki başta ağırlık değerleri rasgele yani hiç bir
doğru karar vermez, ama bu YZ, MCTS ile daha iyi performans
gösterecektir, bu sırada oyundan eğitim verisi toplanır ve bu veri YZ’yi
iyileştirmek için ağa uygulanır, ve işlem başa dönerek devam edilir. Bu
sayede en kötü performanstan en iyisine doğru ilerlemek mümkündür.</p>
<p>Eğitim verisinde hedefin ne olduğunu daha iyi vurgulamak gerekirse,
değer kafası için bu tek bir değer, ilke kafası için tüm 9x9 tahta
pozisyonlarında hangi hamlenin yapılmış olduğu, o hücre 1 diğerleri 0
değerinde olacak. Bu şekilde eğitilen YSA, ilke tahmini üreteceği zaman
tüm hücrelerde olasılık değerleri üretecektir.</p>
<p>Alttaki kod [4]’u baz almıştır. Eğitmek için <code>train.py</code>
kullanılır, eğitim sırasında en son YSA belli aralıklarla sürekli
kaydedilecektir, eğitim sonunda ya da yeterince eğitilince işlem
durulabilir, ve <code>gnugo_play.py</code> kaydedilen aynı modeli
kullanarak GnuGo [1] programına karşı oynatılabilir. YSA olarak biz
ResNet yerine daha basit bir yapı kullandık,</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> simplenet</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>simplenet.PolicyValue.create_network()</span></code></pre></div>
<pre><code>Tensor(&quot;input_1:0&quot;, shape=(?, 17, 9, 9), dtype=float32)
Tensor(&quot;conv2d/BiasAdd:0&quot;, shape=(?, 17, 9, 64), dtype=float32)
Tensor(&quot;batch_normalization/batchnorm/add_1:0&quot;, shape=(?, 17, 9, 64), dtype=float32)
Tensor(&quot;conv2d_2/BiasAdd:0&quot;, shape=(?, 17, 9, 128), dtype=float32)
Tensor(&quot;batch_normalization_2/batchnorm/add_1:0&quot;, shape=(?, 17, 9, 128), dtype=float32)
------------- value -------------------
Tensor(&quot;conv2d_3/BiasAdd:0&quot;, shape=(?, 17, 9, 2), dtype=float32)
Tensor(&quot;activation_3/Relu:0&quot;, shape=(?, 17, 9, 2), dtype=float32)
Tensor(&quot;flatten/Reshape:0&quot;, shape=(?, 306), dtype=float32)
policy_output Tensor(&quot;activation_4/Softmax:0&quot;, shape=(?, 82), dtype=float32)
------------- policy -------------------
Tensor(&quot;conv2d_4/BiasAdd:0&quot;, shape=(?, 17, 9, 1), dtype=float32)
Tensor(&quot;activation_5/Relu:0&quot;, shape=(?, 17, 9, 1), dtype=float32)
Tensor(&quot;flatten_2/Reshape:0&quot;, shape=(?, 153), dtype=float32)
Tensor(&quot;dense_2/BiasAdd:0&quot;, shape=(?, 256), dtype=float32)
Tensor(&quot;activation_6/Relu:0&quot;, shape=(?, 256), dtype=float32)
Tensor(&quot;dense_3/BiasAdd:0&quot;, shape=(?, 1), dtype=float32)
Tensor(&quot;dense_3/BiasAdd:0&quot;, shape=(?, 1), dtype=float32)
Out[1]: &lt;tensorflow.python.keras._impl.keras.engine.training.Model at 0x7fa2dd30de50&gt;</code></pre>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np, resource, sys</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> operator <span class="im">import</span> itemgetter</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>sys.setrecursionlimit(<span class="dv">1500</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>resource.setrlimit(resource.RLIMIT_STACK, [<span class="bn">0x10000000</span>, resource.RLIM_INFINITY])</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>sys.setrecursionlimit(<span class="bn">0x100000</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TreeNode(<span class="bu">object</span>):</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;MCTS agacindaki bir dugum. Her dugum kendi Q degerini, onceki</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">    olasiligi P&#39;yi, ve kac kez ziyaret edildigi sayisiyla duzeltilmis</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">    onsel skoru u&#39;yu biliyor.</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, parent, prior_p):</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._parent <span class="op">=</span> parent</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._children <span class="op">=</span> {} </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._n_visits <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._W <span class="op">=</span> <span class="dv">0</span> </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._Q <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._u <span class="op">=</span> prior_p</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._P <span class="op">=</span> prior_p</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> printing(<span class="va">self</span>):</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="va">self</span>._children)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _, child <span class="kw">in</span> <span class="va">self</span>._children.iteritems():</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>            child.printing()</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> expand(<span class="va">self</span>, action_priors):</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> action, prob <span class="kw">in</span> action_priors:</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> action <span class="kw">not</span> <span class="kw">in</span> <span class="va">self</span>._children:</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>._children[action] <span class="op">=</span> TreeNode(<span class="va">self</span>, prob)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> select(<span class="va">self</span>):        </span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Cocuklar arasinda maksimum aksiyon Q + u(P)&#39;yi vereni sec</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">max</span>(<span class="va">self</span>._children.iteritems(),</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>                   key<span class="op">=</span><span class="kw">lambda</span> act_node: act_node[<span class="dv">1</span>].get_value())</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> update(<span class="va">self</span>, leaf_value, c_puct):</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Dugumu altindaki cocuklardan gelen irdeleme uzerinden guncelle</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="co">        Arguments:</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="co">        leaf_value -- mevcut oyuncu perspektifinden alt agacin degeri</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a><span class="co">        c_puct -- (0, inf) arasinda bir sayi, bu dugumun skoru</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="co">        uzerinde Q ve P&#39;nun etkisini izafi olarak ayarlar</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a><span class="co">        None</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;&quot;&quot;</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._n_visits <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._W <span class="op">+=</span> leaf_value</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._Q <span class="op">=</span> <span class="va">self</span>._W <span class="op">/</span> <span class="va">self</span>._n_visits</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.is_root():</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._u <span class="op">=</span> c_puct <span class="op">*</span> <span class="va">self</span>._P <span class="op">*</span> np.sqrt(<span class="va">self</span>._parent._n_visits) <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> <span class="va">self</span>._n_visits)</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> update_recursive(<span class="va">self</span>, leaf_value, c_puct):</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>._parent:</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._parent.update_recursive(leaf_value, c_puct)</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.update(leaf_value, c_puct)</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_value(<span class="va">self</span>):</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._Q <span class="op">+</span> <span class="va">self</span>._u</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_leaf(<span class="va">self</span>):</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._children <span class="op">==</span> {}</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_root(<span class="va">self</span>):</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._parent <span class="kw">is</span> <span class="va">None</span></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MCTS(<span class="bu">object</span>):</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, value_fn, policy_fn, c_puct<span class="op">=</span><span class="dv">5</span>, n_playout<span class="op">=</span><span class="dv">1600</span>):</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._root <span class="op">=</span> TreeNode(<span class="va">None</span>, <span class="fl">1.0</span>)</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._value <span class="op">=</span> value_fn</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._policy <span class="op">=</span> policy_fn</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._c_puct <span class="op">=</span> c_puct</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._n_playout <span class="op">=</span> n_playout</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _playout(<span class="va">self</span>, state, self_play):</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>        node <span class="op">=</span> <span class="va">self</span>._root</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> node.is_leaf() <span class="kw">and</span> self_play:</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>            tmp <span class="op">=</span> [<span class="fl">0.03</span> <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(node._children.items()))]</span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>            etas <span class="op">=</span> np.random.dirichlet(tmp,<span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>            j <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> action, child_node <span class="kw">in</span> node._children.iteritems():</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>                child_node._P <span class="op">=</span> <span class="fl">0.75</span><span class="op">*</span>child_node._P <span class="op">+</span> <span class="fl">0.25</span><span class="op">*</span>etas[j]</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>                j <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> node.is_leaf():</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>                action_probs <span class="op">=</span> <span class="va">self</span>._policy(state)</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Check for end of game.</span></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">len</span>(action_probs) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> node.is_root() <span class="kw">and</span> self_play:</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>                    tmp <span class="op">=</span> [<span class="fl">0.03</span> <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(action_probs))]</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>                    etas <span class="op">=</span> np.random.dirichlet(tmp,<span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>                    j <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>                    new_action_probs <span class="op">=</span> []</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> action, prob <span class="kw">in</span> action_probs:</span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>                        prob <span class="op">=</span> <span class="fl">0.75</span><span class="op">*</span>prob <span class="op">+</span> <span class="fl">0.25</span><span class="op">*</span>etas[j]</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>                        new_action_probs.append((action, prob))</span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>                        j <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>                    action_probs <span class="op">=</span> new_action_probs</span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>                node.expand(action_probs)</span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Greedily select next move.</span></span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>            action, node <span class="op">=</span> node.select()</span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>            state.do_move(action)</span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Alt dugumunun degerini YSA&#39;yi kullanarak hesapla</span></span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a>        leaf_value <span class="op">=</span> <span class="va">self</span>._value(state)</span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a>        node.update_recursive(leaf_value, <span class="va">self</span>._c_puct)</span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_move(<span class="va">self</span>, state, temperature, self_play):</span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="va">self</span>._n_playout):</span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>            state_copy <span class="op">=</span> state.copy()</span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._playout(state_copy, self_play)</span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> temperature <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>            childrens <span class="op">=</span> <span class="va">self</span>._root._children.items()</span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>            actions, next_states <span class="op">=</span> <span class="bu">map</span>(<span class="bu">list</span>, <span class="bu">zip</span>(<span class="op">*</span>childrens))</span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>            tmp <span class="op">=</span> [next_state._n_visits <span class="cf">for</span> next_state <span class="kw">in</span> next_states]</span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a>            exponentiated_n_visits <span class="op">=</span> np.power(tmp,<span class="fl">1.</span><span class="op">/</span>temperature)</span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>            pi <span class="op">=</span> np.divide(exponentiated_n_visits, np.<span class="bu">sum</span>(exponentiated_n_visits))</span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>            child_idx <span class="op">=</span> <span class="bu">range</span>(<span class="bu">len</span>(childrens))</span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a>            child_idx <span class="op">=</span> np.random.choice(child_idx, p <span class="op">=</span> pi)</span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> actions[child_idx]</span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> : <span class="co"># when temperature is infinitesimal</span></span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">max</span>(<span class="va">self</span>._root._children.iteritems(),</span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>                       key<span class="op">=</span><span class="kw">lambda</span> act_node: act_node[<span class="dv">1</span>]._n_visits)[<span class="dv">0</span>]</span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> update_with_move(<span class="va">self</span>, last_move):</span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> last_move <span class="kw">in</span> <span class="va">self</span>._root._children:</span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._root <span class="op">=</span> <span class="va">self</span>._root._children[last_move]</span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._root._parent <span class="op">=</span> <span class="va">None</span></span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._root <span class="op">=</span> TreeNode(<span class="va">None</span>, <span class="fl">1.0</span>)</span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MCTSPlayer(<span class="bu">object</span>):</span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, value_function, policy_function, c_puct<span class="op">=</span><span class="dv">5</span>, n_playout<span class="op">=</span><span class="dv">1600</span>, evaluating<span class="op">=</span><span class="va">True</span>, self_play<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mcts <span class="op">=</span> MCTS(value_function, policy_function, c_puct, n_playout)</span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.move_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.evaluating <span class="op">=</span> evaluating</span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.self_play <span class="op">=</span> self_play</span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.evaluating:</span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a>            temperature <span class="op">=</span> <span class="fl">0.</span></span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a>            temperature <span class="op">=</span> <span class="fl">1.</span></span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.temperature <span class="op">=</span> temperature</span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.is_human <span class="op">=</span> <span class="va">False</span> <span class="co"># for playing a game in play.py</span></span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_move(<span class="va">self</span>, state, self_play<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a>        sensible_moves <span class="op">=</span> [move <span class="cf">for</span> move <span class="kw">in</span> state.get_legal_moves()]</span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(sensible_moves) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a>            move <span class="op">=</span> <span class="va">self</span>.mcts.get_move(state, <span class="va">self</span>.temperature, <span class="va">self</span>.self_play)</span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> self_play:</span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.mcts.update_with_move(move)</span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.move_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.evaluating :</span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="va">self</span>.move_count <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.temperature <span class="op">=</span> <span class="fl">0.</span></span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> move</span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.move_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.evaluating:</span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.move_count <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.temperature <span class="op">=</span> <span class="fl">0.</span></span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> go.PASS_MOVE</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os, glob, pickle, go</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json, re, util</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shutil <span class="im">import</span> copy</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mcts <span class="im">import</span> MCTSPlayer</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> util <span class="im">import</span> flatten_idx, pprint_board</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.contrib.keras <span class="im">import</span> optimizers <span class="im">as</span> O</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.contrib.keras <span class="im">import</span> callbacks <span class="im">as</span> C</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.contrib.keras <span class="im">import</span> backend <span class="im">as</span> K</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> resnet</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> simplenet</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> self_play_and_save(player, opp_player):</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    state_list <span class="op">=</span> []</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    pi_list <span class="op">=</span> []</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    player_list <span class="op">=</span> []</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    state <span class="op">=</span> go.GameState(size<span class="op">=</span><span class="dv">9</span>, komi<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    player_color <span class="op">=</span> go.BLACK</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    current <span class="op">=</span> player</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    other <span class="op">=</span> opp_player</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    step <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="kw">not</span> state.is_end_of_game:</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        move <span class="op">=</span> current.get_move(state, self_play<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        childrens <span class="op">=</span> current.mcts._root._children.items()</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        actions, next_states <span class="op">=</span> <span class="bu">map</span>(<span class="bu">list</span>, <span class="bu">zip</span>(<span class="op">*</span>childrens))</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        _n_visits <span class="op">=</span> [next_state._n_visits <span class="cf">for</span> next_state <span class="kw">in</span> next_states]</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> move <span class="op">==</span> go.PASS_MOVE:</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> step <span class="op">&lt;</span> <span class="dv">25</span>: <span class="co"># temperature is considered to be 1</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>                distribution <span class="op">=</span> np.divide(_n_visits, np.<span class="bu">sum</span>(_n_visits))</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>                max_visit_idx <span class="op">=</span> np.argmax(_n_visits)</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>                distribution <span class="op">=</span> np.zeros(np.shape(_n_visits))</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>                distribution[max_visit_idx] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>: <span class="co"># to prevent the model from overfitting to PASS_MOVE</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>            distribution <span class="op">=</span> np.zeros(np.shape(_n_visits))</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>        pi <span class="op">=</span> <span class="bu">zip</span>(actions, distribution)</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>        pi_list.append(pi)</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>        state_list.append(state.copy())</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>        current.mcts.update_with_move(move)</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>        state.do_move(move)</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>        other.mcts.update_with_move(move)</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>        current, other <span class="op">=</span> other, current</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>        step <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>    winner <span class="op">=</span> state.get_winner()</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span> (<span class="st">&#39;winner&#39;</span>, winner)</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># oyun bitti kimin kazandigini biliyoruz, mesela siyah kazandiysa</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># odulleri hamle bazinda +1,-1,+1,.. olacak sekilde ata, beyaz</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># kazandiysa -1,+1,-1 seklinde. Siyah olunca +1 cunku oyuna hep siyah</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># basliyor.</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> winner <span class="op">==</span> go.BLACK:</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>        reward_list <span class="op">=</span> [(<span class="op">-</span><span class="fl">1.</span>)<span class="op">**</span>j <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(state_list))]</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> : <span class="co"># winner == go.WHITE:</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>        reward_list <span class="op">=</span> [(<span class="op">-</span><span class="fl">1.</span>)<span class="op">**</span>(j<span class="op">+</span><span class="dv">1</span>) <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(state_list))]</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> state_list, pi_list, reward_list</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> self_play_and_train(cmd_line_args<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># iki farkli ag yarat, egitim bunlardan ilkini gunceller.</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># belli bir sure sonra oteki YSA ilkinin kaydettigi veriden guncellenir,</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ve ikisi tekrar esit hale gelir, bu boyle devam eder.</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>    policy <span class="op">=</span> simplenet.PolicyValue(simplenet.PolicyValue.create_network())</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>    opp_policy <span class="op">=</span> simplenet.PolicyValue(simplenet.PolicyValue.create_network())</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> lr_scheduler(epoch):</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> epoch <span class="op">==</span> <span class="dv">5000</span>:</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>            K.set_value(model.optimizer.lr, <span class="fl">.001</span>)</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> epoch <span class="op">==</span> <span class="dv">7000</span>:</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>            K.set_value(model.optimizer.lr, <span class="fl">.0001</span>)</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> K.get_value(model.optimizer.lr)</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    change_lr <span class="op">=</span> C.LearningRateScheduler(lr_scheduler)</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>    sgd <span class="op">=</span> O.SGD(lr<span class="op">=</span><span class="fl">.01</span>, momentum<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>    policy.model.<span class="bu">compile</span>(loss<span class="op">=</span>[<span class="st">&#39;categorical_crossentropy&#39;</span>,<span class="st">&#39;mean_squared_error&#39;</span>],</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>                         optimizer<span class="op">=</span>sgd)        </span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>    batch_size <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>    n_pick <span class="op">=</span> <span class="dv">10</span> <span class="co"># her oyundan kac veri noktasi alalim</span></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1000</span>):</span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>        state_list2 <span class="op">=</span> []</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>        pi_list2 <span class="op">=</span> []</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>        reward_list2 <span class="op">=</span> []        </span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="va">True</span>: <span class="co"># batch_size kadar veri toplayincaya kadar oyna</span></span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>                player <span class="op">=</span> MCTSPlayer(policy.eval_value_state,</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>                                    policy.eval_policy_state,</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>                                    n_playout<span class="op">=</span><span class="dv">50</span>, evaluating<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>                                    self_play<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>                opp_player<span class="op">=</span> MCTSPlayer(opp_policy.eval_value_state,</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>                                       opp_policy.eval_policy_state,</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>                                       n_playout<span class="op">=</span><span class="dv">50</span>, evaluating<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>                                       self_play<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>                state_list, pi_list, reward_list <span class="op">=</span> self_play_and_save(</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>                    opp_player, player</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>                <span class="co"># oyunda atilan tum adimlar, sonuclar state_list,</span></span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>                <span class="co"># pi_list, reward_list listesi icinde. Simdi rasgele</span></span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>                <span class="co"># n_pick tane veri noktasi her oyun kaydindan cekip</span></span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>                <span class="co"># cikartilir.</span></span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>                idxs <span class="op">=</span> [np.random.choice(<span class="bu">range</span>(<span class="dv">10</span>,<span class="bu">len</span>(state_list)),replace<span class="op">=</span><span class="va">False</span>) <span class="op">\</span></span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n_pick)]</span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span> (<span class="st">&#39;picked results&#39;</span>, idxs)</span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> idx <span class="kw">in</span> idxs:</span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>                    state_list2.append(state_list[idx])</span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>                    pi_list2.append(pi_list[idx])</span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>                    reward_list2.append(reward_list[idx])</span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">len</span>(state_list2) <span class="op">&gt;=</span> batch_size: <span class="cf">break</span></span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span> (<span class="st">&#39;exception&#39;</span>)</span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>        pout <span class="op">=</span> np.zeros((batch_size, <span class="dv">9</span><span class="op">*</span><span class="dv">9</span><span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>        vout <span class="op">=</span> np.zeros((batch_size, <span class="dv">1</span>))</span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>        Y <span class="op">=</span> [pout, vout]</span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> np.zeros((batch_size, <span class="dv">17</span>, <span class="dv">9</span>, <span class="dv">9</span>))</span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(state_list2)):</span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a>            vout[i,:] <span class="op">=</span> reward_list2[i]</span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a>            X[i, :] <span class="op">=</span> util.get_board(state_list2[i])</span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a>            pout[i,:] <span class="op">=</span> util.to_pi_mat(pi_list2[i])</span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a>                                                </span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a>        policy.model.fit(X, Y)</span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> epoch <span class="op">%</span> <span class="dv">5</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span> (<span class="st">&#39;saving&#39;</span>)</span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a>            policy.save()</span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> epoch <span class="op">%</span> <span class="dv">50</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span> (<span class="st">&#39;birincinin en son kayitli agirliklarindan bu agi guncelle&#39;</span>)</span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a>            opp_policy.load()</span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a>    self_play_and_train()</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.contrib.keras <span class="im">import</span> regularizers <span class="im">as</span> R</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.contrib.keras <span class="im">import</span> models <span class="im">as</span> M</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.contrib.keras <span class="im">import</span> layers <span class="im">as</span> L</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.contrib.keras <span class="im">import</span> backend <span class="im">as</span> K</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> util <span class="im">import</span> flatten_idx, random_transform, idx_transformations</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np, util, random</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>mfile <span class="op">=</span> <span class="st">&quot;/tmp/alphago-zero.h5&quot;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PolicyValue:</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model):</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> save(<span class="va">self</span>):</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model.save_weights(mfile)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> load(<span class="va">self</span>):</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model.load_weights(mfile)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> eval_policy_state(<span class="va">self</span>, state):</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> util.get_board(state).reshape(<span class="dv">1</span>, <span class="dv">17</span>, <span class="dv">9</span>, <span class="dv">9</span>)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        probs1 <span class="op">=</span> <span class="va">self</span>.model.predict(x)[<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        probs2 <span class="op">=</span> probs1[<span class="dv">1</span>:].reshape(<span class="dv">9</span>,<span class="dv">9</span>)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        res_probs <span class="op">=</span> [(action,probs2[action]) <span class="op">\</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">for</span> action <span class="kw">in</span> state.get_legal_moves() <span class="cf">if</span> action]</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        res_probs.append((<span class="va">None</span>, probs1[<span class="dv">0</span>]))</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> res_probs</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> eval_value_state(<span class="va">self</span>, state):</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> util.get_board(state).reshape(<span class="dv">1</span>, <span class="dv">17</span>, <span class="dv">9</span>, <span class="dv">9</span>)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.model.predict(x)[<span class="dv">1</span>][<span class="dv">0</span>][<span class="dv">0</span>]</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_network(<span class="op">**</span>kwargs):</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>        model_input <span class="op">=</span> L.Input(shape<span class="op">=</span>(<span class="dv">17</span>, <span class="dv">9</span>, <span class="dv">9</span>))</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (model_input)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>        convolution_path <span class="op">=</span> L.Convolution2D(</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>            input_shape<span class="op">=</span>(),</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>            filters<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>            kernel_size<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>            activation<span class="op">=</span><span class="st">&#39;linear&#39;</span>,</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>            padding<span class="op">=</span><span class="st">&#39;same&#39;</span>,</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>            kernel_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>),</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>            bias_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>))(model_input)</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (convolution_path)</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>        convolution_path <span class="op">=</span> L.BatchNormalization(</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>            beta_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>),</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>            gamma_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>))(convolution_path)</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (convolution_path)</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>        convolution_path <span class="op">=</span> L.Activation(<span class="st">&#39;relu&#39;</span>)(convolution_path)</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>        convolution_path <span class="op">=</span> L.Convolution2D(</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>            input_shape<span class="op">=</span>(),</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>            filters<span class="op">=</span><span class="dv">128</span>,</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>            kernel_size<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>            activation<span class="op">=</span><span class="st">&#39;linear&#39;</span>,</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>            padding<span class="op">=</span><span class="st">&#39;same&#39;</span>,</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>            kernel_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>),</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>            bias_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>))(convolution_path)</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (convolution_path)</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>        convolution_path <span class="op">=</span> L.BatchNormalization(</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>            beta_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>),</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>            gamma_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>))(convolution_path)</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (convolution_path)</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>        convolution_path <span class="op">=</span> L.Activation(<span class="st">&#39;relu&#39;</span>)(convolution_path)</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (<span class="st">&#39;------------- value -------------------&#39;</span> )</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># policy head</span></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>        policy_path <span class="op">=</span> L.Convolution2D(</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>            input_shape<span class="op">=</span>(),</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>            filters<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>            kernel_size<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>            activation<span class="op">=</span><span class="st">&#39;linear&#39;</span>,</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>            padding<span class="op">=</span><span class="st">&#39;same&#39;</span>,</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>            kernel_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>),</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>            bias_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>))(convolution_path)</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (policy_path)</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>        policy_path <span class="op">=</span> L.BatchNormalization(</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>                beta_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>),</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>                gamma_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>))(policy_path)</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>        policy_path <span class="op">=</span> L.Activation(<span class="st">&#39;relu&#39;</span>)(policy_path)</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (policy_path)</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>        policy_path <span class="op">=</span> L.Flatten()(policy_path)</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (policy_path)</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>        policy_path <span class="op">=</span> L.Dense(</span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>                (<span class="dv">9</span><span class="op">*</span><span class="dv">9</span>)<span class="op">+</span><span class="dv">1</span>,</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>                kernel_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>),</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>                bias_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>))(policy_path)</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>        policy_output <span class="op">=</span> L.Activation(<span class="st">&#39;softmax&#39;</span>)(policy_path)</span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (<span class="st">&#39;policy_output&#39;</span>, policy_output)</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (<span class="st">&#39;------------- policy -------------------&#39;</span>)</span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>        <span class="co"># value head</span></span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>        value_path <span class="op">=</span> L.Convolution2D(</span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>            input_shape<span class="op">=</span>(),</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>            filters<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>            kernel_size<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>            activation<span class="op">=</span><span class="st">&#39;linear&#39;</span>,</span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>            padding<span class="op">=</span><span class="st">&#39;same&#39;</span>,</span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>            kernel_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>),</span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>            bias_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>))(convolution_path)</span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (value_path)</span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>        value_path <span class="op">=</span> L.BatchNormalization(</span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>                beta_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>),</span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>                gamma_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>))(value_path)</span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>        value_path <span class="op">=</span> L.Activation(<span class="st">&#39;relu&#39;</span>)(value_path)</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (value_path)</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>        value_path <span class="op">=</span> L.Flatten()(value_path)</span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (value_path)</span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>        value_path <span class="op">=</span> L.Dense(</span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>                <span class="dv">256</span>,</span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>                kernel_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>),</span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>                bias_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>))(value_path)</span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (value_path)</span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a>        value_path <span class="op">=</span> L.Activation(<span class="st">&#39;relu&#39;</span>)(value_path)</span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (value_path)</span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a>        value_path <span class="op">=</span> L.Dense(</span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a>                <span class="dv">1</span>,</span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>                kernel_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>),</span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a>                bias_regularizer<span class="op">=</span>R.l2(<span class="fl">.0001</span>))(value_path)</span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (value_path)</span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a>        value_output <span class="op">=</span> L.Activation(<span class="st">&#39;tanh&#39;</span>)(value_path)</span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (value_path)</span>
<span id="cb5-127"><a href="#cb5-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-128"><a href="#cb5-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> M.Model(inputs<span class="op">=</span>[model_input], outputs<span class="op">=</span>[policy_output, value_output])</span></code></pre></div>
<p>İki YSA kendisine karşı oynarken aynı ağırlıklara sahip iki farklı
YSA ile başlıyoruz, ve oyun sonuçlarını kullanarak sadece birini
güncelliyoruz. Eğer her toptan demeti (minibatch) ile her iki YSA’yı
güncelleseydik birbirlerinden farklılaşmaları zorlaşabilirdi. Ama
döngünün daha ileri bir noktasında esitleme yapariz yine de, ilk YSA’yı
güncellenenin ağırlıklarını diskten okuyarak güncelliyoruz, ve böyle
devam ediyor. AGZ tasarımcıları “en iyi’’ olan ağırlıklara geçmeden yeni
YSA’nın diğerini yüzde 55’ten fazla yenmesi şartını koymuşlar, tam
donanımla testleri yapanlar bunu takip ederse iyi olur.</p>
<p>Üstteki mimari birkaç saat eğitim sonrası GnuGo (kendi YZ’si olan bir
dış Go programı) başlangıç, orta seviyelerini yenebiliyor. Okuyucular,
grafik kartlı güçlü bir mimaride, ya üstteki YSA’yı derinleştirerek
(daha fazla evrişim filtresi ekleyerek), ya da <code>resnet.py</code>
ile, ve <code>n_play</code>’i arttırarak daha fazla simülasyonla
sonuçları daha da iyileştirmeye uğraşabilirler.</p>
<p>Kodlar</p>
<p><a href="resnet.py">resnet.py</a>, <a href="train.py">train.py</a>,
<a href="gnugo_play.py">gnugo_play.py</a>, <a
href="mcts.py">mcts.py</a></p>
<p>Kaynaklar</p>
<p>[1] Bayramlı, <em>Go Oyunu, GnuGo</em>, <a
href="https://burakbayramli.github.io/dersblog/sk/2018/02/go-gnugo.html">https://burakbayramli.github.io/dersblog/sk/2018/02/go-gnugo.html</a></p>
<p>[2] Silver, <em>Mastering the game of Go with deep neural networks
and tree search</em>, <a
href="https://www.nature.com/articles/nature16961">https://www.nature.com/articles/nature16961</a></p>
<p>[3] Weidman, <em>The 3 Tricks That Made AlphaGo Zero Work</em>, <a
href="https://hackernoon.com/the-3-tricks-that-made-alphago-zero-work-f3d47b6686ef">https://hackernoon.com/the-3-tricks-that-made-alphago-zero-work-f3d47b6686ef</a></p>
<p>[4] Yi, <em>A reproduction of Alphago Zero in ‘Mastering the game of
Go without human knowledge’</em>, <a
href="https://github.com/sangyi92/alphago_zero">https://github.com/sangyi92/alphago_zero</a></p>
<p>[5] <em>AlphaGo Zero Cheat Sheet</em>, <a
href="https://applied-data.science/static/main/res/alpha_go_zero_cheat_sheet.png">https://applied-data.science/static/main/res/alpha_go_zero_cheat_sheet.png</a></p>
<p>[6] Kristiadi, <em>Residual Net</em>, <a
href="https://wiseodd.github.io/techblog/2016/10/13/residual-net/">https://wiseodd.github.io/techblog/2016/10/13/residual-net/</a></p>
<p>
  <a href="..">Yukarı</a>
</p>
</body>
</html>
