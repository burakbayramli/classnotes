\documentclass[12pt,fleqn]{article}\usepackage{../../common}
\begin{document}
Direkli Araba, Ters Sarkaç (Cart Pole, Inverted Pendulum)

Sadece saða ve sola giden bir araba üzerinde duran bir direk var. Bu
direðin üzerinde bir kütle var; acaba bu direði sadece arabayý saða sola
götürerek dengeleyebilir miyiz? Belki bazýlarýmýz elimiz üzerinde bir
sopayý dengelemeye uðraþmýþýzdýr, yapmaya çalýþacaðýmýz buna çok benziyor.  

\includegraphics[width=15em]{phy_cartpole_01.png}

Sistemin hareket denklemlerini modellemek için Lagrange formüllerini
kullanacaðýz. $L = K - P$ üzerinden,

$$
L = \frac{1}{2} M v_1^2 + \frac{1}{2} m v_2^2 - m g \ell \cos\theta
$$

$v_1$ arabanýn hýzý, $v_2$ ise þarkacýn hýzý. $x(t)$ arabanýn yerini
belirleyecek. Hýzlarý yer türeviyle deðiþtirebiliriz, mesela
$v_1^2 = \dot{x}^2$. Sarkacýn hýzý $v_2$'yi onun yeri üzerinden tanýmlamak
gerekiyor, þarkacýn yeri nedir? Onun yatay, dikey kordinatlarýna bakalým,
dikey $x-\ell\sin\theta$, dikey $\ell\cos\theta$. Genel
$v^2 = v_x^2 + v_y^2$ formülü üzerinden,

$$
v_2^2 = 
\left( \frac{\ud}{\ud t} (x - \ell\sin\theta) \right)^2 + 
\left( \frac{\ud}{\ud t} (x - \ell\cos\theta) \right)^2 
$$

$v_2$'yi basitleþtirince, 

$$
v_2^2 = \dot{x}^2 - 2 \ell \dot{x}\dot{\theta}\cos\theta + \ell^2 \dot{\theta}^2
$$

Lagrangian þu hale geliyor,

$$
L = 
\frac{1}{2} (M + m) \dot{x}^2 - 
m \ell \dot{x}\dot{\theta} \cos\theta +
\frac{1}{2} m \ell^2 \dot{\theta}^2 - 
m g \ell \cos\theta
$$

Þimdi Euler-Lagrange denklemlerini yazalým,

$$
\frac{\ud}{\ud t} \frac{\partial L}{\partial \dot{x}} -
\frac{\partial L}{\partial x}  = F
$$

$$
\frac{\ud}{\ud t} \frac{\partial L}{\partial \dot{\theta}} -
\frac{\partial L}{\partial \theta}  = 0
$$

Ýki üstteki denklemde eþitliðin sað tarafýnda $F$ var, niye sýfýr deðil?
Hamilton ve Lagrange-d'Alembert prensibine göre dýþ kuvvetler bir sisteme
eþitliðin sað tarafýndan dahil edilebilir. Ayrýca hiza doðru oranda ters
yönde etki eden bir sürtünme kuvveti $\mu\dot{x}$ de ekleriz. $L$'yi
üstteki denklemlere sokarsak ve basitleþtirirsek ters sarkacýn hareket
denklemlerini elde ediyoruz.

$$
(M+m) \ddot{x} + 
m \ell \ddot{\theta} \cos\theta - 
m \ell \dot{\theta}^2 \sin\theta + \mu\dot{x} = F
$$

$$
\ell \ddot{\theta} - g \sin\theta + \ddot{x} \cos\theta = 0
$$


{\em Gayri-Lineer Dinamik ve Kaos, Ders 6}'da Jacobian matrisi ile denge
noktalarý yakýnýnda bir sistemi nasýl lineerize edebileceðimizi gördük. Ýki
boyutta $x^*,y^*$ denge noktasý yakýnýnda, $\dot{u} = \dot{x} = f(x,y)$ ve
$\dot{v} = \dot{y} = g(x,y)$ ODE sistem için mesela, ya da,

$$
\left[\begin{array}{r}
\dot{u} \\ \dot{v}
\end{array}\right] = 
\left[\begin{array}{r}
f(x,y) \\ g(x,y)
\end{array}\right] 
$$

için, lineerizasyon sonrasý þöyle bir görüntü var,

$$
\left[\begin{array}{r}
\dot{u} \\ \dot{v}
\end{array}\right]
=
\left[\begin{array}{rr}
\frac{\partial f}{\partial x} & \frac{\partial f}{\partial y} \\
\frac{\partial g}{\partial x} & \frac{\partial g}{\partial y} 
\end{array}\right]_{x^*,y^*}
\left[\begin{array}{r} u \\ v \end{array}\right]
+ ...
$$

Noktalý kýsýmlarý atarsak 1. dereceden bir yaklaþýksallama ve lineerizasyon
elde ediyoruz ve görülen $x^*,y^*$ noktasýndaki deðerleri kullanýlan 2x2
matrisi Jacobian matrisidir. 

Sarkac denklemlerine donersek, bu denklemleri su sekilde tekrar
duzenleyebiliriz, 

$$
\left[\begin{array}{rr}
M+m & m l \cos\theta \\ \cos\theta & l
\end{array}\right]
\left[\begin{array}{r}
\ddot{x} \\ \ddot{\theta}
\end{array}\right] 
=
\left[\begin{array}{c}
m l \dot{\theta}^2 \sin\theta - \mu \dot{x} \\
g \sin\theta
\end{array}\right] + 
\left[\begin{array}{r}
1 \\ 0
\end{array}\right] F
$$

$$
\left[\begin{array}{r}
\ddot{x} \\ \ddot{\theta}
\end{array}\right] 
=
\left[\begin{array}{rr}
M+m & m l \cos\theta \\ \cos\theta & l
\end{array}\right]^{-1}
\left(
  \left[\begin{array}{c}
  m l \dot{\theta}^2 \sin\theta - \mu \dot{x} \\
  g \sin\theta
  \end{array}\right] + 
  \left[\begin{array}{r}
  1 \\ 0
  \end{array}\right] F
\right)
$$

1. derece ODE sistemi elde etmek için konum vektörünü tanýmlayalým, 

$$
\frac{\ud}{\ud t} \left[\begin{array}{r}
x_1 \\ x_2 \\ x_3 \\ x_4
\end{array}\right] = 
\frac{\ud}{\ud t} 
\left[\begin{array}{r}
x \\ \theta \\ \dot{x} \\ \dot{\theta}
\end{array}\right]
$$

$x_1,x_2$'nin ne olduðu basit. $x_3,x_4$ için iki üstteki denklem
gerekiyor, daha doðrusu görülen matris iþlemlerini yapýp 1. ve
2. satýrlarýný $x_3,x_4$ için kullanabiliriz. Önce gerekli $x_i$ deðiþken
deðiþimlerini yaparýz,

$$
\left[\begin{array}{rr}
M+m & m l \cos x_2 \\ \cos x_2 & l
\end{array}\right]^{-1}
\left(
  \left[\begin{array}{c}
  m l x_4^2 \sin x_2 - \mu x_3 \\
  g \sin x_2
  \end{array}\right] + 
  \left[\begin{array}{r}
  1 \\ 0
  \end{array}\right] F
\right)
$$

Bu cebirsel olarak oldukca çetrefil bir iþlem. \verb!sympy! ile iþlemler
daha kolay yapýlabilir,

\begin{minted}[fontsize=\footnotesize]{python}
import sympy

x1, x2, x3, x4 = sympy.symbols('x1 x2 x3 x4')
M, m, l, mu, g, F = sympy.symbols('m M l mu g F',constant = True)

a = sympy.Matrix([[M+m, m*l*sympy.cos(x2)],[sympy.cos(x2), l]])

b = sympy.Matrix([m * l * x4**2 * sympy.sin(x2) - mu*x3 + F , g * sympy.sin(x2)])

c = a.inv() * b
\end{minted}

Üstteki elde edilen matrisin 1. ve 2. satýrý sýrasýyla alttaki noktalý
yerlere gelecek,

$$
\frac{\ud}{\ud t} \left[\begin{array}{rrr}
x_1 \\ x_2 \\ x_3 \\ x_4
\end{array}\right] = 
\left[\begin{array}{c}
x_3 \\ x_4 \\ \textrm{.. 1. satýr ...} \\ \textrm{.. 2. satýr ...}
\end{array}\right]
$$

ODE eþitliðinin saðýndaki matrisi elde ettik. Bu matrisin Jacobian'inin
kritik nokta $(0,0,0,0)$'daki deðerini bulabiliriz. Tüm bu iþlemler de
\verb!sympy! ile yapýlabilir. Önce $x$ üzerinden Jacobian,

\begin{minted}[fontsize=\footnotesize]{python}
tmp = sympy.diff(c[0], x2).subs({x1:0,x2:0,x3:0,x4:0}).simplify()
print(sympy.latex(tmp), ',')
tmp = sympy.diff(c[0], x3).subs({x1:0,x2:0,x3:0,x4:0}).simplify()
print(sympy.latex(tmp), ',')
tmp = sympy.diff(c[1], x2).subs({x1:0,x2:0,x3:0,x4:0}).simplify()
print(sympy.latex(tmp), ',')
tmp = sympy.diff(c[1], x3).subs({x1:0,x2:0,x3:0,x4:0}).simplify()
print(sympy.latex(tmp), ',')
\end{minted}

\begin{verbatim}
- \frac{M g}{m} ,
- \frac{\mu}{m} ,
\frac{g \left(M + m\right)}{l m} ,
\frac{\mu}{l m}
\end{verbatim}

$$
- \frac{M g}{m} ,
- \frac{\mu}{m} ,
\frac{g \left(M + m\right)}{l m} ,
\frac{\mu}{l m} 
$$

Ardindan $F$ icin Jacobian

\begin{minted}[fontsize=\footnotesize]{python}
tmp = sympy.diff(c[0], F).subs({x1:0,x2:0,x3:0,x4:0}).simplify()
print(sympy.latex(tmp), ',')
tmp = sympy.diff(c[1], F).subs({x1:0,x2:0,x3:0,x4:0}).simplify()
print(sympy.latex(tmp))
\end{minted}

\begin{verbatim}
\frac{1}{m} ,
- \frac{1}{l m}
\end{verbatim}

$$
\frac{1}{m} ,
- \frac{1}{l m}
$$

\begin{minted}[fontsize=\footnotesize]{python}
print (sympy.simplify(c[0]))
print (sympy.latex(sympy.simplify(c[0])))
print (sympy.simplify(c[1]))
print (sympy.latex(c[1]))
\end{minted}

\begin{verbatim}
(F - M*g*sin(2*x2)/2 + M*l*x4**2*sin(x2) - mu*x3)/(M*sin(x2)**2 + m)
\frac{F - \frac{M g \sin{\left(2 x_{2} \right)}}{2} + M l x_{4}^{2} \sin{\left(x_{2} \right)} - \mu x_{3}}{M \sin^{2}{\left(x_{2} \right)} + m}
(g*(M + m)*sin(x2) - (F + M*l*x4**2*sin(x2) - mu*x3)*cos(x2))/(l*(M*sin(x2)**2 + m))
\frac{g \left(M + m\right) \sin{\left(x_{2} \right)}}{- M l \cos^{2}{\left(x_{2} \right)} + l \left(M + m\right)} - \frac{\left(F + M l x_{4}^{2} \sin{\left(x_{2} \right)} - \mu x_{3}\right) \cos{\left(x_{2} \right)}}{- M l \cos^{2}{\left(x_{2} \right)} + l \left(M + m\right)}
\end{verbatim}

$$
\ddot{x} = x_3 = \frac{F - \frac{M g \sin{\left(2 x_{2} \right)}}{2} + M l x_{4}^{2} \sin{\left(x_{2} \right)} - \mu x_{3}}{M \sin^{2}{\left(x_{2} \right)} + m}
$$

$$
\ddot{\theta} = x_4 = \frac{g \left(M + m\right) \sin{\left(x_{2} \right)} - \left(F + M l x_{4}^{2} \sin{\left(x_{2} \right)} - \mu x_{3}\right) \cos{\left(x_{2} \right)}}{l \left(M \sin^{2}{\left(x_{2} \right)} + m\right)}
$$



\begin{minted}[fontsize=\footnotesize]{python}
from scipy.integrate import odeint
import control, gym, time
import numpy as np
from numpy import sin, cos

import matplotlib.pyplot as plt
import numpy as np
import math
import time

l_bar = 2.0  # length of bar
l = l_bar 
m = 0.3  # [kg]
g = 9.8
m = 0.3
M = 1.0
l = 1.0
mu = 0.1 # friction
Q = np.array([[100., 0., 0., 0.],[0, 1, 0, 0],[0, 0, 1000, 0],[0, 0, 0, 1]] )
R = 0.0001
#init_theta = -5.0
init_theta = 0.5
x0 = [0.0, 0.0, init_theta, 2.0]

def flatten(a):
    return np.array(a).flatten()

def show_cart(fout, xt, theta):
    cart_w = 1.0
    cart_h = 0.5
    radius = 0.1

    cx = np.matrix([-cart_w / 2.0, cart_w / 2.0, cart_w /
                    2.0, -cart_w / 2.0, -cart_w / 2.0])
    cy = np.matrix([0.0, 0.0, cart_h, cart_h, 0.0])
    cy += radius * 2.0

    cx = cx + xt

    bx = np.matrix([0.0, l_bar * math.sin(-theta)])
    bx += xt
    by = np.matrix([cart_h, l_bar * math.cos(-theta) + cart_h])
    by += radius * 2.0

    angles = np.arange(0.0, math.pi * 2.0, math.radians(3.0))
    ox = [radius * math.cos(a) for a in angles]
    oy = [radius * math.sin(a) for a in angles]

    rwx = np.copy(ox) + cart_w / 4.0 + xt
    rwy = np.copy(oy) + radius
    lwx = np.copy(ox) - cart_w / 4.0 + xt
    lwy = np.copy(oy) + radius

    wx = np.copy(ox) + float(bx[0, -1])
    wy = np.copy(oy) + float(by[0, -1])

    plt.figure()
    plt.plot(flatten(cx), flatten(cy), "-b")
    plt.plot(flatten(bx), flatten(by), "-k")
    plt.plot(flatten(rwx), flatten(rwy), "-k")
    plt.plot(flatten(lwx), flatten(lwy), "-k")
    plt.plot(flatten(wx), flatten(wy), "-k")
    plt.xlim(-3, 3)
    plt.savefig(fout)
        
A = np.array([[0, 0, 1, 0],
    [0, 0, 0, 1],
    [0, -(M/m)*g, -mu/m, 0],
    [0, (m+M)*g/m*l, mu/m*l, 0]])
    
B = np.array([[0], [0], [1/m],[-1/m*l]])

K,X,e = control.lqr(A,B,Q,R);

def rhs(x, t):

    x1,x2,x3,x4 = x
    xs = np.array([1,0,0,0])
    F = np.float(np.dot(K,(xs - np.array([x1,x2,x3,x4]))))

    tmp1 = (F - M*g*sin(2*x2)/2 + M*l*x4**2*sin(x2) - mu*x3) \ 
           /(M*sin(x2)**2 + m)

    tmp2 = (g*(M + m)*sin(x2) - (F + M*l*x4**2*sin(x2) - mu*x3)*cos(x2)) \ 
           /(l*(M*sin(x2)**2 + m))

    return [x3, x4, tmp1, tmp2 ]


t = np.linspace(0, 5, 100)
sol = odeint(rhs, x0, t)

for i,row in enumerate(sol):
    if i % 5 == 0:
        show_cart('frames1/cart-%04d' % i, row[0], row[1])
\end{minted}

$\theta = 0.5$

\includegraphics[width=17em]{frames1/cart-0005.png}
\includegraphics[width=17em]{frames1/cart-0015.png}

\includegraphics[width=17em]{frames1/cart-0020.png}
\includegraphics[width=17em]{frames1/cart-0030.png}

$\theta = -5.0$

\includegraphics[width=17em]{frames2/cart-0005.png}
\includegraphics[width=17em]{frames2/cart-0015.png}

\includegraphics[width=17em]{frames2/cart-0020.png}
\includegraphics[width=17em]{frames2/cart-0030.png}




2.160 pdf sf 75 algebr ricc

[devam edecek]

Kaynaklar

[1] Wikipedia, {\em Inverted Pendulum}, \url{wikipedia.com/Inverted_pendulum}

[2] Wikipedia, {\em Optimal control}, \url{wikipedia.com/Optimal_control}

[3] Gutman, {\em Technion, Linear Systems Lecture}, \url{http://leo.technion.ac.il/Courses/LS/}

\end{document}
