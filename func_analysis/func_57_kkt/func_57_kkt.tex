\documentclass[12pt,fleqn]{article}\usepackage{../../common}
\begin{document}
Karush-Kuhn-Tucker (KKT) Þartlarý

KKT þartlarý birkaç basit kavramýn bir araya gelmesiyle oluþan çok kuvvetli
bir kavram. Bu þartlar 4 tane. Alttaki gibi genel bir problemle baðlantýlýlar,

$$
\min_x f(x) \quad \textrm{öyle ki}
$$
$$
h_i(x) \le 0, \quad i=1,..,m
$$
$$
l_j(x) = 0, \quad j=1,..,r
$$

Lagrangian'ý hatýrlarsak, 

$$
L(x,u,v) =  f(x) + 
\sum_{i=1}^{m} u_i \underbrace{h_i(x)}_{\le 0} + 
\sum_{i=1}^{r} v_i \underbrace{l_i(x)}_{=0}
$$

Problemin dýþbükey olmasý mecbur deðil. 

Bu þartlar,

1) Duraðanlýk þartý

Lagrangian'da $u,v$ sabitledim, ve $x$'e göre Lagrangian'ýn altgradyanýný
alýrsam, 0 deðeri bu altgradyan içinde olmalý. 

$$
0 \in \partial_x \left(
f(x) + \sum_{i=1}^{m} u_i h_i(x) + \sum_{j=1}^{r} v_j l_j(x) 
\right)
$$

2) Tamamlayýcý Gevþeklik (Complementary Slackness)

$$
u_i \cdot h_i(x) = 0 \quad \forall i
$$

Üstteki þart diyor ki ya $h_i(x)$ sýfýr olmalý, yani $i$'inci eþitsizlik
sýký olmalý, ya da ona tekabül eden ikiz deðiþken $u_i$ sýfýr olmalý, yani
eþitsizlik ya sýký -eþitlik- ya da dikkate alýnmamalý.

3) Ana Olurluk

$$
h_i(x) \le 0, \quad l_j(x) = 0 \quad \forall i,j
$$

4) Ýkiz Olurluðu

$$
u_i \ge 0, \quad \forall i
$$

Optimallik için $x,u,v$ üstteki 4 þartý yerine getirmeli, genel baðlamda bu
o $x$'in ana problemi, $u,v$'nin ikiz problemi çözmesi anlamýna geliyor. 

Ýspatlayalým. Önce ters yönden gelerek bir ispat, diyelim ki elimde ana ve
ikiz çözümler var. Eðer o ``çözüm varsa, oradan KKT þartlarý meydana
çýkmalý'' ispatýný görelim. Bu yöne ``gereklilik'' (necessary)
denebilir. Diyelim ki $x^*$, ve $u^*,v^*$ ana ve ikiz çözümleri var, ve
ikizlik boþluðu sýfýr (yani güçlü ikizlik aktif, Slater þartýný
hatýrlarsak). O zaman

$$
f(x^*) = g(u^*,v^*)
$$

Taným itibariyle, her $u,v$ için $g(u,v)$ fonksiyou Lagrangian'ýn $x$
üzerinden minimumu. Üsttekinden hareketle ve $u,v$ için $u^*,v^*$
kullanýrsak,

$$
= \min_x f(x) + \sum_{i=1}^{m} u_i^* h_i(x) + \sum_{j=1}^{r} v_j^* l_j(x) 
$$
 
Üstte minimum buluyorum yani $x$ üzerinden üstteki Lagrangian'ý $x^*$'deki
halinden daha fazla ufaltmam mümkün deðil,

$$
\le f(x^*) + \sum_{i=1}^{m} u_i{^*} h_i(x^*) + \sum_{j=1}^{r} v_j{^*} l_j(x^*) 
\mlabel{1}
$$

Devam edersek, $u_i^*$ olurlu, o zaman üstteki ortadaki terim $\ge 0$,
$v_i^*$ olurlu o zaman üçüncü terim sýfýr. Bu demektir ki üstteki ifade
$f(x^*)$'den daha az olmalý.

$$
\le f(x^*) 
\mlabel{2}
$$

Sonuç olarak 

$$
f(x^*) \le f(x^**)
$$

elde ettik, o zaman üstteki ifade aslýnda eþitsizlik deðil bir eþitlik
çünkü eþitsizliðin iki tarafýnda ayný þey var. 

Eþitsizliklerin eþitlik olmasý ne anlama gelir? Demek ki $x^*$ Lagrangian'ý
$u^*,v^*$ noktasýnda minimize edecektir. Duraðanlýk bu demek zaten deðil
mi? $x$'e göre Lagrangian'ýn altgradyanýný aldým ve bu sýfýra eþit.  Ayrýca
tamamlayan gevþeklik þartý da ispatlanmýþ oluyor, (1) ile (2) eþit
olmalýysa, ve (1)'deki 3. terimin sýfýr olduðunu biliyoruz, 2. terimdeki
tamamý pozitif olan toplam öðeleride sýfýr olmalý çünkü baþka türlü (2)'ye
eþitliði elde edemeyiz. Eh bu durum da tamamlayan gevþeklik þartý deðil
midir?

Ana-ikiz olurluðunu zaten bedava elde ettik. Elimizde bir çözüm varsa onlar
ana-ikiz olurlu olmalý. 

Yani ispatlamýþ olduk ki eðer elimizde ana-ikiz boþluðu olmayan bir çözüm
varsa, $x^*,u^*,v^*$ çözüm üçlüsü KKT koþullarýna uymaktadýr. KKT
koþularýnýn güçlü ikizlik durumunda þart olduðunu göstermiþ olduk.

Diðer yönden ispat etmeye uðraþalým. 

Elimizde KKT þartlarýný tatmin eden bir $x^*,u^*,v^*$ üçlüsü olduðunu
düþünelim, ve bu üçlünün optimal olmasý gerektiðini ispat edelim, yani
$x^*$'in ana $u^*,v^*$'nin ikiz problem için optimal olmasý
gerektiðini.. Eðer $x^*,u^*,v^*$ KKT þartlarýna uygunsa, duraðanlýða göre

$$
g(u^*,v^*) = f(x^*) + \sum_{i=1}^{m} u_i{^*} h_i(x^*) + \sum_{j=1}^{r} v_j{^*} l_j(x^*) 
\mlabel{3}
$$

Bu tabii $g$ tanýmý ile baðlý,

$$
g(u^*,v^*) = \min_x L(x,u^*,v^*)
$$

ve duraðanlýkla 

$$
= \min_x L(x^*,u^*,v^*)
$$

böylece üç üstteki taným ortaya çýkýyor. 

(3) içindeki ikinci terimde tamamlayýcý gevþekliði uygularsak toplamdaki
her öge $x^*$ için sýfýr, toplam sýfýr, ikinci terim tamamen sýfýr.

KKT koþullarýndan bir diðeri olurluk, o zaman (3)'teki üçüncü terimde her
toplam öðesi sýfýr, toplam sýfýr. Geriye tek kalan

$$
g(u^*,v^*) = f(x^*) + 
\cancel{\sum_{i=1}^{m} u_i{^*} h_i(x^*)} + 
\cancel{\sum_{j=1}^{r} v_j{^*} l_j(x^*)}
$$

$$
= f(x^*)
$$

Eðer $g(u^*,v^*) = f(x^*)$ ise o zaman ana ve ikiz kriter arasýnda ikizlik
boþluðu yoktur demektir, ve daha önce gördüðümüz gibi bu elimizdekinin bir
çözüm olduðunun iþaretidir. 

Yani birkaç farklý yönden gelerek ispatladýk ki $x^*$ ve $u^*,v^*$ KKT
koþullarýna uyuyorsa, o zaman elimizdekiler optimal ana ve ikiz
çözümleridir. KKT koþullarý her zaman yeterlidir. Dikkat edilirse
dýþbükeylikten hiç bahsetmedik, KKT yeterli (sufficient), onlara uygunluk
varsa optimal ana ve ikiz çözüme eriþmiþiz demektir. Gereklilik (necessary)
durumu eðer güçlü dýþbükeylik varsa, elimizdeki çözüm KKT koþullarýna da
uymaya mecbur. Biraz söz cambazlýðý gibi gelebilir ama tanýmlarýn net
olmasý, ve ilerideki teorilere faydasý açýsýndan bu iyi. 

Soru

Eðer KKT koþullarýný tatmin etmek optimallik için yeterliyse dünyadaki her
problemi KKT üzerinde rahatça çözebilir miyim?

Hayýr çünkü 1. KKT þartý, duraðanlýk þartýyla problem çýkabilir. Pürüzsüz
bir problem için duraðanlýk için $f$ ve $h_i,l_i$'in gradyanlarýný almam
yeter, sýfýra eþitlerim vs. Bir de dýþbükeylik varsa tipik olarak
altgradyaný yazmak basittir. Sonucu bulmak her zaman kolay olmayabilir ama
en azýndan duraðanlýðý formülize etmek kolaydýr. Fakat bazý fonksiyonlarda
dýþbükeylik yoksa altgradyanlarý hesaplamanýn zorluðu ötesinde bazen
altgradyan olmayabilir bile. Genelde pürüzsüz durumlarda KKT koþullarýný
kullanmanýn zor tarafý budur.

Bu sebeple formel bir uyarýyý slaytlara koyduk, ``eðer $f$ dýþbükey deðilse
türevi alýnabilir bir $f$ için bile direk $\partial f = \{\nabla f(x)\}$
diyemeyiz''. 

Eðer ana problemde hiçbir kýsýtlama olmasaydý o zaman 2. 3. ve 4. KKT
þartlarý yokoluyor bu normal çünkü ikiz deðiþken olmayacak, 1. þarttaki
2. ve 3. terim yokolur, sadece altgradyanýn sýfýrý içerme þartý geriye
kalýyor. Bazen bilimcilerin bu tür problemlerde salt altgradyan optimalliði
kullanýp ``KKT koþullarý kullandým'' dediðini duyabilirsiniz, ben bile
dalgýnlýkla bunu söyleyebiliyorum bazen. Fonksiyon var, altgradyanýný alýp
sýfýra eþitliyorum, bu ``KKT koþulu'' diyorum. Teknik olarak doðru tabii,
sadece KKT'nin çok basit bir hali bu.

Örnek

Eþitlik þartlarý olan karesel bir fonksiyonun minimizasyonuna bakalým. 

$$
\min_x \frac{1}{2} x^T Q x + c^T x \quad \textrm{öyle ki}
$$
$$
Ax = 0
$$

$Q \succ 0$ olacak, yani $Q$ pozitif yarý-kesin, o zaman üstteki problem
dýþbükey. Eþitsizlik þartý yok.

KKT þartlarýný yazalým. Lagrangian nedir? 

$$
L(x,u) = \frac{1}{2} x^T Q x + c^T x + u^T A x
$$

Duraðanlýk için üsttekinin gradyanýný alýp sýfýra eþitlerim, 

$$
Qx + c + A^T u = 0
$$

Tamamlayýcý gevþeklik

(Boþ, çünkü eþitsizlik þartlarý yok)

Ana-ikiz olurluk

Ýkiz olurluk boþ, çünkü eþitsizlik yok, yani $u$'nin pozitif olma þartý
yok. Ana olurluk ise 

$$
Ax = 0
$$

Biliyoruz ki üstteki iki þartý tatmin edersem $x$ ana, $u$ ikiz optimal
çözüm olacak. 

Güzel deðil mi? Hatta bu lineer bir sistem olarak yazýlabilir,

$$
\left[\begin{array}{ccc}
Q & A^T \\ A & 0
\end{array}\right]
\left[\begin{array}{c}
x \\ u
\end{array}\right] =
\left[\begin{array}{r}
-c \\ 0
\end{array}\right] 
$$

Eðer üstteki sistemi $x,u$ bulmak için çözersem, optimal noktalarý
bulabilirim. Eðer matris tersi alýnabilir ise tersini alýrým, eþitliðin
saðýndaki ifade ile çarparým, bu bana ana-ikiz sonucu verir. 

Üstteki matrise bazen KKT matrisi deniyor, KKT koþullarýný kullanarak
oluþturulduðu için. 

[atlandý, su doldurma problemi, SVM]

Ekler

Örnek

Þimdi [2]'den alýnan bir örneði görelim. 

$$
\min_{x_1,x_2} x_1^2 + x_2^2 \quad \textrm{öyle ki}
$$
$$
x_1 + x_2 = 5
$$

Burada bir eþitlikle kýsýtlanmýþ QP (equality constrained QP) var ve biraz
önce gördüðümüz KKT matrisini oluþturarak onu tek adýmda çözebiliriz. 
Kriter ve kýsýtlama matris formunda þöyle, $x = (x_1,x_2)$ alýrsak,

$$
f(x) = \frac{1}{2} x^T 
\underbrace{
\left[\begin{array}{cc}
2 & 0 \\ 0 & 2
\end{array}\right]}_{Q} x + 
\left[\begin{array}{cc}
0 & 0
\end{array}\right]^T x
$$
$$
\underbrace{
\left[\begin{array}{cc}
1 & 1
\end{array}\right]}_{A}
\left[\begin{array}{c}
x_2 \\ x_2
\end{array}\right] = 5
$$

(Sýfýr vektörü var çünkü $x_1^2,x_2^2$ içeren terimler var ama $x_1,x_2$
içeren terimler yok)

KKT matrisini þöyle oluþtururuz, 

$$
\left[\begin{array}{ccc}
Q & A^T \\ A & 0
\end{array}\right]
\left[\begin{array}{c}
x \\ u
\end{array}\right] =
\left[\begin{array}{r}
-c \\ b
\end{array}\right] 
$$

$$
\left[\begin{array}{ccc}
2 & 0 & 1 \\
0 & 2 & 1 \\
1 & 1 & 0
\end{array}\right]
\cdot
\left[\begin{array}{c}
x_1 \\ x_2 \\ u
\end{array}\right] = 
\left[\begin{array}{c}
0 \\ 0 \\ 5
\end{array}\right] 
$$

\begin{minted}[fontsize=\footnotesize]{python}
import numpy.linalg as lin
X = np.array([[2,0,1],[0,2,1],[1,1,0]]) 
a = np.array([[0],[0],[5]])
print (lin.solve(X,a))
\end{minted}

\begin{verbatim}
[[ 2.5]
 [ 2.5]
 [-5. ]]
\end{verbatim}

Doðrulamak için paket ile çözelim,

\begin{minted}[fontsize=\footnotesize]{python}
from cvxopt import matrix
from cvxopt import solvers
Q = matrix([ [2.0, 0], [0, 2.0] ])
p = matrix([0.0, 0.0])
G = matrix([[0.0,0.0],[0.0,0.0]])
h = matrix([0.0,0.0])
A = matrix([1.0, 1.0], (1,2))
b = matrix(5.0)
sol=solvers.qp(Q, p, G, h, A, b)
print (sol['x'])
\end{minted}

\begin{verbatim}
     pcost       dcost       gap    pres   dres
 0:  1.2500e+01  1.2500e+01  2e+00  1e+00  1e-15
 1:  1.2500e+01  1.2500e+01  2e-02  1e-02  0e+00
 2:  1.2500e+01  1.2500e+01  2e-04  1e-04  0e+00
 3:  1.2500e+01  1.2500e+01  2e-06  1e-06  0e+00
 4:  1.2500e+01  1.2500e+01  2e-08  1e-08  0e+00
Optimal solution found.
[ 2.50e+00]
[ 2.50e+00]
\end{verbatim}

Ekler

Soru

Eðer KKT þartýný eþitlik sýnýrlanmýþ QP (bilahere LP) çözmek için
kullanabiliyorsam, ve mesela LP diyelim, her eþitsizlik içeren problemi
standardizasyon ile eþitlikle sýnýrlý probleme çevirebiliyorsam, KKT
matrisi ile her türlü LP'yi çözemez miyim? Niye farklý metotlara giriþ
yapmak gerekiyor? 

Cevap

Standardizasyon sonrasý hala elimizde pozitiflik sýnýrlamalarý var, ki
bunlar da birer eþitsizlik sýnýrý aslýnda. KKT matrisi çözmek bu
eþitsizlikleri tatmin etmez, basit bir matris tersi alýyoruz, elimize geçen
deðiþkenlerin pozitif kalma zorunluluðunu bu metot ile zorlayamayýz.

Kaynaklar

[1] Tibshirani, {\em Convex Optimization, Lecture Video 12}, 
\url{https://www.youtube.com/channel/UCIvaLZcfz3ikJ1cD-zMpIXg}   

[2] Lendek, {\em Optimization Lecture, Quadratic Programming}
\url{http://www.lendek.net/teaching/opt_en/}

\end{document}
