\documentclass[12pt,fleqn]{article}\usepackage{../../common}
\begin{document}
Sezonsallık, Trend Çıkartmak, Değişim Noktası, CUSUM

Zaman serilerini trendini, sezonşallığını nasıl inceleriz, ve trendde
değişim varsa bunu nasıl yakalarız? 

Bir örnek üzerinde görelim, bir şirketin şampuan satış kazancı, veri [1]'den,

\begin{minted}[fontsize=\footnotesize]{python}
import pandas as pd
def parser(x):
    return pd.datetime.strptime( '190'+x, '%Y-%m' )
    
df = pd.read_csv('shampoo-sales.csv', header=0, index_col=0, \
     parse_dates=True, date_parser=parser)
df.Satis.plot()
plt.savefig('tser_022_de_07.png')
\end{minted}

\includegraphics[height=6cm]{tser_022_de_07.png}

Yukarı doğru bir trend var. Bu trendi veriye bir düz çizgi uydurarak (fit), yani
tek değişkenli, ikinci derece lineer regresyon yaparak yakalayabiliriz. Bunu
yapmayı pek çok diğer derste gösterdik, \verb!statsmodels.regression!
paketinden, \verb!linear_model.OLS! ile, \verb!statsmodels.formula.api! ile,
ya da direk Lineer Cebir kullanarak.. Altta \verb!polyfit!  çağrısı
kullanılacak.

Modelden gelen katsayıları (coefficients) kullanıp tahmini $y$ değerleri üretmek
için alttaki fonksiyon var,

\begin{minted}[fontsize=\footnotesize]{python}
def model_compute(X, coef):
   degree = len(coef)-1
   curve = [np.sum([coef[-1]] + [x**(degree-d)*c for d,c \
            in enumerate(coef[:-1])]) for x in X]
   return curve
\end{minted}

Uydurmayı yapıp modeli veri üzerinde gösterelim,

\begin{minted}[fontsize=\footnotesize]{python}
X = np.array(range(len(df))).reshape(-1)
y = df.values.reshape(-1)
degree = 1
coef = np.polyfit(X, y, degree)
df['Model']  = model_compute(X, coef)
df.plot()
plt.savefig('tser_022_de_01.png')
\end{minted}

\includegraphics[height=6cm]{tser_022_de_01.png}

Veriden ``trendi çıkartmabiliriz''. Bunu basit bir şekilde veriden modeli
çıkartarak, yani eksilterek yapabiliriz. Bu durumda geriye kalan sadece ``trend
haricinde olan şeyler'' olacaktır. Trend çıkartmanın pek çok sebebi olabilir,
belki trend haricinde olan kalıpları, eğer varsa, görmek istiyoruz, ya da
modelin artığına (residual) bakarak onun gürültü olup olmadığını anlamak
istiyoruz. Bilindiği gibi lineer regresyonun faraziyesi verinin model artı
gürültü olduğudür, o zaman model veriden çıkartılınca geriye kalan artık,
``tortu'' sadece gürültü olmalıdır. Gürültünün matematiksel tanımı Gaussian, ya
da Normal dağılımıdır, demek ki artıklar üzerinde normallik testi bir anlamda
modelin uyma başaarısını da ölçer. 

\begin{minted}[fontsize=\footnotesize]{python}
detrended = df.Satis-df.Model
detrended.plot()
plt.savefig('tser_022_de_03.png')
\end{minted}

\includegraphics[height=6cm]{tser_022_de_03.png}

Normallik testini uygulayalım,

\begin{minted}[fontsize=\footnotesize]{python}
from scipy import stats
val,pval = stats.shapiro(detrended)
print ('p degeri =', pval)
\end{minted}

\begin{verbatim}
p degeri = 0.09782794862985611
\end{verbatim}

Shapiro-Wilk testinde p-değerinin 0.05'ten küçük olması normalliğin reddedilmesi
demektir. Üstteki normal olmadığın reddedemedik, demek ki büyük ihtimalle
elimizde bir Normal dağılım var.

Sezonsallık

\begin{minted}[fontsize=\footnotesize]{python}
import pandas as pd
df = pd.read_csv('daily-min-temperatures.csv', header=0,\
                 index_col=0, parse_dates=True)
X = [i%365 for i in range(0, len(df))]
y = df.values
degree = 4
coef = np.polyfit(X, y, degree)
df['Model']  = model_compute(X, coef)
df.plot()
plt.savefig('tser_022_de_02.png')
\end{minted}

\includegraphics[height=6cm]{tser_022_de_02.png}

\begin{minted}[fontsize=\footnotesize]{python}
deseasoned = df.Temp-df.Model
deseasoned.plot()
plt.savefig('tser_022_de_04.png')
\end{minted}

\includegraphics[height=6cm]{tser_022_de_04.png}




Cusum

\inputminted[fontsize=\footnotesize]{python}{cusum.py}

\begin{minted}[fontsize=\footnotesize]{python}
import pandas as pd
  
y = np.random.randn(300)/5
y[100:200] += np.arange(0, 4, 4/100)
x = range(len(y))
df = pd.DataFrame(y,columns=['y'])
df['x'] = x
df = df.set_index('x')
df.y.plot()
plt.savefig('tser_022_de_05.png')
\end{minted}

\includegraphics[height=6cm]{tser_022_de_05.png}

\begin{minted}[fontsize=\footnotesize]{python}
import cusum
ta, tai, taf, amp = cusum.detect_cusum(df.y, 2, .02, True, True)

fig, ax = plt.subplots(1, 1)
t = range(df.y.size)
ax.plot(t, df.y, 'b-', lw=2)
if len(ta):
    ax.plot(tai, df.y[tai], '>', mfc='g', mec='g', ms=10, label='Start')
    ax.plot(taf, df.y[taf], '<', mfc='g', mec='g', ms=10, label='Ending')
    ax.plot(ta, df.y[ta], 'o', mfc='r', mec='r', mew=1, ms=5, label='Alarm')
    
plt.savefig('tser_022_de_06.png')
\end{minted}

\includegraphics[height=6cm]{tser_022_de_06.png}

\begin{minted}[fontsize=\footnotesize]{python}
print (len(ta))
print ('Baslangic =', tai[0], 'Bitis =', taf[0])
\end{minted}

\begin{verbatim}
2
Baslangic = 95 Bitis = 197
\end{verbatim}




 












Kaynaklar

[1] Brownlee, {\em Introduction to Time Series Modeling with Python}

[2] Github, \url{https://raw.githubusercontent.com/BMClab/BMC/master/functions/detect_cusum.py}

[3] MIT, {\em OCW Single Variable Calculus, unit 5, Session 99},
         \url{https://ocw.mit.edu/courses/mathematics/18-01sc-single-variable-calculus-fall-2010/index.htm}

[4] Bayramli, {\em Hesapsal Bilim, Ders 1-15}
         
[5] Brown, et al, {\em Techniques for Testing the Constancy of Regression Relationships over Time}

\end{document}
