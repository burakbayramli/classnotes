\documentclass[12pt,fleqn]{article}\usepackage{../../common}
\begin{document}
Momentum Stratejileri

Momentum kelimesi akýlda ivmeli bir hareketi çaðrýþtýrýyor, yani olmakta
olan bir gidiþatýn olmaya devam etmesi gibi görebiliriz bu kavramý. Bu tür
bir kalýcýlýk, yukarý ya da aþaðý doðru, borsacý için al/sat baðlamýnda
önemli bir sinyaldir ve kar amaçlý olarak kullanýlabilir. 

Araþtýrmacýlar bazen varlýk fiyatlarýndaki momentumu ikiye ayýrýyorlar;
zaman serisi momentumu ve kesitsel (cross-sectional) momentum. Zaman serisi
momentumu basit: bir serinin gelecekteki getirisinin geçmiþteki getirisi
ile arasýnda pozitif korelasyon vardýr. Kesitsel durumda ise izafi bir olay
vardýr: eðer bir serinin getirisi diðer serilerden daha iyi olmuþ ise, bu
performans büyük bir ihtimalle bu þekilde devam edecektir, ya da tersi
durumda, kötü performans kötü olmaya devam edecektir. 

Zaman serisi korelasyonunu ölçmek için istatistiki korelasyon hesabýný
kullanabiliriz, ki bu hesap ayrýca bir p-deðeri de hesaplýyor (korelasyon
olmadýðý sýfýr hipotezinin sýfýr deðeri), çok düþük p-deðeri korelasyon
varlýðýna dair bir iþaret.

Korelasyon hesaplarken bir zaman adýmý / gecikmesi (lag) seçmek
lazým. Mesela 1 günlük bazýnda hesaplanmýþ geçmiþ ve gelecek getirileri
arasýnda negatif korelasyon bulunabilir, ama 20 günlük adýmlar üzerinden
hesaplanmýþ getirilerin 40 günlük adýmlar üzerinden hesaplanmýþ gelecek
getirileri arasýnda pozitif korelasyon bulunabilir. Bu tabii ki önemli
çünkü bu bize 20 günlük sinyal üzerinden 40 günlük elde tutma (ya da açýða
satma) iþlemi yapmamýz gerektiðini söylüyor.

Örnek olarak 2 yýllýk Hazine Vadeli Ýþlem Sözleþmesinin (Treasury Future)
fiyatýný iþleyelim. Bu varlýðýn geçmiþteki ve gelecekteki farklý
kombinasyondaki adýmlar üzerindeki getirilerinin korelasyonunu test
edeceðiz; mesela geçmiþ getiriyi (lookback) 5 günlük adýmlardan hesaplayýp,
geleceði (hold days) 10 günlük adýmlardan hesaplamak gibi. Ya da 10-10,
25-60, vs, ve tüm bu farklý kombinasyonlarýn verilerinin ikili olarak
korelasyonunu alýp onlarýn p-deðerini hesaplayacaðýz.

\begin{minted}[fontsize=\footnotesize]{python}
import sys; sys.path.append('../tser_draw_sharpe')
import pandas as pd
df = pd.read_csv('TU.csv')
\end{minted}

\begin{minted}[fontsize=\footnotesize]{python}
import sys; sys.path.append('../tser_coint')
import corr

res = []
for lookback in [1, 5, 10, 25, 60, 120, 250]:
   for holddays in [1, 5, 10, 25, 60, 120, 250]:
       df_Close_lookback = df.Close.shift(lookback)
       df_Close_holddays = df.Close.shift(-holddays)
       df['ret_lag'] = (df.Close-df_Close_lookback)/df_Close_lookback
       df['ret_fut'] = (df_Close_holddays-df.Close)/df.Close
       dfc = df[['ret_lag','ret_fut']].dropna()
       idx = None
       if lookback >= holddays: 
           idx = np.array(range(0,len(dfc.ret_lag), holddays))
       else: 
           idx = np.array(range(0,len(dfc.ret_lag), lookback))
       dfc = dfc.ix[idx]
       t, x, p = corr.p_corr(dfc.ret_lag, dfc.ret_fut)
       res.append([lookback, holddays,  t, p])
res = pd.DataFrame(res,columns=['geriye bakis','tutma gunu','korelasyon','p degeri'])
print res[res['geriye bakis'] >= 25]
\end{minted}

\begin{verbatim}
    geriye bakis  tutma gunu  korelasyon  p degeri
21            25           1   -0.013846  0.270625
22            25           5    0.032196  0.263327
23            25          10    0.151663  0.017386
24            25          25    0.194388  0.045128
25            25          60    0.233075  0.021371
26            25         120    0.149209  0.102255
27            25         250    0.261104  0.015751
28            60           1    0.031111  0.088828
29            60           5    0.079022  0.063314
30            60          10    0.170948  0.009661
31            60          25    0.182575  0.059741
32            60          60    0.213958  0.123890
33            60         120   -0.036387  0.424304
34            60         250    0.318615  0.049219
35           120           1    0.021126  0.187942
36           120           5    0.053784  0.157502
37           120          10    0.092116  0.112675
38           120          25    0.152030  0.104487
39           120          60   -0.023771  0.451293
40           120         120    0.217406  0.227647
41           120         250    0.403921  0.085531
42           250           1    0.040612  0.058007
43           250           5    0.105563  0.034167
44           250          10    0.178648  0.014633
45           250          25    0.273233  0.018136
46           250          60    0.319392  0.064088
47           250         120    0.354586  0.142317
48           250         250    0.512954  0.188391
\end{verbatim}

Kod bir anlamda her zaman aný için o andaki tarihsel getiri ve eðer o
noktada pozisyon alýnmýþ olsa eldeki varlýðýn tutulmasýndan elde edilecek
getiri hesabýný yapýyor. Bu iki hesaptan iki zaman serisi türetiliyor,
sonra geriye bakýþ, tutma günü arasýndan ufak olaný oranýnda bu seri
örnekleniyor (sample). Niye bu örnekleme? Bu lazým, çünkü geriye bakýþ,
alýþ belli aralýklardan yapýlýr, çok ufak (ya da hiç) örnekleme yapsak
birbiriyle çakýþan hesaplarý üst üste görmüþ olurduk.

Seçimimizi yapmak için en iyi korelasyon katsayýsý ve p-deðeri arasýnda bir
denge gözetmek gerektiðini görüyoruz, bazen iyi olabilecek bir katsayý için
p-deðeri iyi olmayabiliyor.  (60, 10), (60, 25), (250, 10), (250, 25),
(250, 60), (250, 120) eþleri bu baðlamda en iyi dengede olanlar herhalde,
ve al/sat yapmaya gelince bizim genel tercihimiz düþük elde tutma gününe ve
ayrýca en yüksek Sharpe oranýna sahip olan varlýklar tabii ki. Para
kazanmak için 10 gün mü 100 gün mü beklemek daha iyi? Eðer getiriler kabaca
iki tarafta eþit ise 10 gün tercihimiz!

Þimdi getiriyi hesaplayalým. Bu hesap için 250,25 kombinasyonunu seçelim,
bu kombinasyonun katsayýsý 0.273233 p-deðeri 0.018. Fena deðil. Stratejiyi
þöyle kodlayacaðýz, eðer geçmiþteki 12 aylýk (aþaðý yukarý 250 gün) getiri
pozitif ise, hisseyi alýp bu pozisyonda 1 ay (25 gün) dur. Pozitif /
negatif bize al / sat yönünde sinyal çünkü korelasyon olduðunu biliyoruz ya
artýk, demek ki eskiden çýkmýþsa gelecekte çýkacak, düþmüþse gelecekte
düþecek. Bu bilinen bir strateji aslýnda ama biz onu biraz deðiþtirdik,
al/sat kararýný her ay vermeye çalýþmak yerine her gün vereceðiz, ve her
gün alým/satým için sermayemizin 1/25'ini kullanacaðýz.

\begin{minted}[fontsize=\footnotesize]{python}
import dd

def report(df,lookback,holddays):

    longs = df.Close > df.Close.shift(lookback)
    shorts = df.Close < df.Close.shift(lookback)
    df['pos'] = 0.
    for h in range(holddays):
       long_lag = longs.shift(h).fillna(False)
       short_lag = shorts.shift(h).fillna(False)
       df.loc[long_lag,'pos'] += 1
       df.loc[short_lag,'pos'] -= 1

    ret=(df.pos.shift(1)* (df.Close-df.Close.shift(1)) / df.Close.shift(1)) \
         / holddays # sermayenin holddays'lik parcasini kullan

    cumret=np.cumprod(1+ret)-1

    print 'APR', ((np.prod(1.+ret))**(252./len(ret)))-1
    print 'Sharpe', np.sqrt(252.)*np.mean(ret)/np.std(ret)
    print 'Dusus Kaliciligi', dd.calculateMaxDD(np.array(cumret))
    return cumret

cumret=report(dftu,lookback = 250,holddays = 25)
\end{minted}

\begin{verbatim}
APR 0.0167080584229
Sharpe 1.04172346649
Dusus Kaliciligi (-0.024847461773700896, 343.0)
\end{verbatim}

Tabii al/sat kararlaþtýrýnca bu al ve satlarýn 25 gün elde tutulmasý ve
bunlarýn birikmesi durumunu hesaplamak lazým, bunu da $h=0,1,..,25$ kadar
kaydýrýp bu kaydýrýlmýþ 25 vektörü toplayarak elde elde ediyoruz, mesela
sadece 3 vektör için gösterelim,

\begin{verbatim}
+ + + ... - - + - ...
  + + + ... - - + - ...
    + + + ... - - + - ...
\end{verbatim}

Üstteki ilk satýr al/sat kararlarý, arka arkaya 3 al kararý var, bunlar
toplana toplana 3. günde 3 birim varlýk birikmiþ olacak, ayný þekilde
satlar eksiltilir, vs. Diðer hesaplar önceden gördüðümüz tanýdýk getiri,
kumulatif getiri hesaplarý.

\begin{minted}[fontsize=\footnotesize]{python}
plt.plot(cumret)
plt.title(u'Kümülatif Birleþik Getiri')
plt.savefig('tser_mom_01.png')
\end{minted}

\includegraphics[height=6cm]{tser_mom_01.png}

Ayný stratejiyi diðer bazý vadeli iþlemler HG, BRE üzerinde kullanýrsak,

\begin{minted}[fontsize=\footnotesize]{python}
dfhg = pd.read_csv('HG.csv')
cumret = report(dfhg,lookback = 40,holddays = 40)
\end{minted}

\begin{verbatim}
APR 0.177399755457
Sharpe 1.04800326416
Dusus Kaliciligi (-0.23984679762413508, 424.0)
\end{verbatim}

\begin{minted}[fontsize=\footnotesize]{python}
plt.plot(cumret)
plt.savefig('tser_mom_04.png')
\end{minted}

\includegraphics[height=6cm]{tser_mom_04.png}

\begin{minted}[fontsize=\footnotesize]{python}
dfbre = pd.read_csv('BRE.csv')
cumret = report(dfbre,lookback = 100,holddays = 10)
\end{minted}

\begin{verbatim}
APR 0.177086083041
Sharpe 1.08707778803
Dusus Kaliciligi (-0.14812255240727923, 191.0)
\end{verbatim}

\begin{minted}[fontsize=\footnotesize]{python}
plt.plot(cumret)
plt.savefig('tser_mom_05.png')
\end{minted}

\includegraphics[height=6cm]{tser_mom_05.png}

Boþluk Görünce Alým (Buy on Gap)

Deðiþik bir momentum stratejisi ``boþluk görünce iþlem yapmak''. Mesela bir
varlýðýn kapanýþ (close) getirilerini bir pencere üzerinden yürüyen
ortalamayla (moving average) hesaplýyoruz, böylece bir baz þablon
oluþturuyoruz, eðer bir günün açýlýþ (open) fiyatý bu þablon getiri, çarpý
önceki günün en yüksek (high) fiyatýndan belli oranda yüksek ise alým
yapýyoruz, önceki günün en düþük (low) fiyatýndan belli oranda düþük ise
satým yapýyoruz. Yani yükselme trendi var, bir momentum oluþmuþ, bu devam
ediyor, bu alým sinyalidir, ya da tersi olmuþtur bu satýþ sinyalidir.

Altta FSTX sembolüne sahip Dow Jones STOXX 50 vadeli iþlem sözleþmesinin
(futures) üzerinde bu tekniði görebiliriz,

\begin{minted}[fontsize=\footnotesize]{python}
import pandas as pd, dd
df = pd.read_csv('FSTX.csv')
entryZscore=0.1

stdret = pd.rolling_mean(df.cl.pct_change(), window=90).shift(1)
longs = df.op >= df.hi.shift(1)*(1+entryZscore*stdret)
shorts = df.op <= df.lo.shift(1)*(1-entryZscore*stdret)
df['pos'] = 0
df.loc[longs,'pos'] = 1
df.loc[shorts,'pos'] = -1
ret=df.pos * (df.op-df.cl) / df.op
ret = ret.dropna()
cumret=np.cumprod(1+ret)-1
print 'APR', ((np.prod(1.+ret))**(252./len(ret)))-1
print 'Sharpe', np.sqrt(252.)*np.mean(ret)/np.std(ret)
print 'Dusus Kaliciligi', dd.calculateMaxDD(np.array(cumret))
\end{minted}

\begin{verbatim}
APR 0.140771737387
Sharpe 1.35989260747
Dusus Kaliciligi (-0.14880173773680128, 190.0)
\end{verbatim}

\begin{minted}[fontsize=\footnotesize]{python}
plt.plot(cumret)
plt.title(u'Kümülatif Birleþik Getiri')
plt.savefig('tser_mom_02.png')
\end{minted}

\includegraphics[height=6cm]{tser_mom_02.png}

Þirket Kar Açýklamalarý

Kar açýklamalarýnýn þirket fiyatlarýna momentum vermesi þaþýrtýcý
deðil. Fakat bu açýklamanýn ardýndan nispeten uzun bir süre bu
etkinin sürmesi ilginç. Daha ilginç olan bu etki uzun süredir biliniyor ve
kullanýla kullanýla etkisi yokolabilirdi, fakat bu hala gerçekleþmedi! 

Kâr açýklamalarýný kullanan strateji çok basit: açýklamanýn ``iyi'' ya da
``kötü'' olduðunu bile bilmemize gerek yok, o sinyali almak için yine
piyasanýn kendisini kullanacaðýz. Eðer önceki gün kapanýþ sonrasý bir
açýklama yapýlmýþsa, ve yine önceki günün kapanýþý ve bugünin açýlýþý
üzerinden hesaplanan getiri ``yeterince'' pozitif ise (ki bunu hareketli
standart sapmaya izafi olarak hesaplayacaðýz), senedi al, yoksa açýða sat,
ve günün kapanýþýnda tüm pozisyonlardan çýk. Burada yapmaya uðraþtýðýmýz
momentumu, bir senet etrafýnda olan ``heyecaný'' açýlýþýn önceki günün
kapanýþýna göre farkýndan anlamaya çalýþmak.

Altta bu stratejinin S\&P 500 senetleri üzerinde ve Ocak 3, 2011, to Nisan
24, 2012 arasýnda geriye dönük testini görüyoruz. Þirket kar açýklamalarý,
açýlýþ, kapanýþ fiyatlarý farklý matrisler içinde. Her matrisin
kolonlarýnda þirketler var, satýrlarý ise zaman. Geriye bakýþ zamaný 90
gün. Kar açýklama verisi \url{earnings.com} sitesinden alýnmýþ.

\begin{minted}[fontsize=\footnotesize]{python}
import pandas as pd, zipfile, dd
with zipfile.ZipFile('earnann.zip', 'r') as z:
    earnann =  pd.read_csv(z.open('earnann.csv'),sep=',')
    op =  pd.read_csv(z.open('earnann-op.csv'),sep=',')
    cl =  pd.read_csv(z.open('earnann-cl.csv'),sep=',')
\end{minted}

\begin{minted}[fontsize=\footnotesize]{python}
lookback=90
retC2O=(op-cl.shift(1)) / cl.shift(1)
stdC2O=pd.rolling_std(retC2O, window=lookback)
pos = pd.DataFrame(np.zeros(cl.shape),index=cl.index,columns=cl.columns)
longs=(retC2O >= 0.5*stdC2O).astype(int) * earnann
shorts=(retC2O <= -0.5*stdC2O).astype(int) * earnann;
pos = pos + longs - shorts
ret=(pos*(cl-op)/op).sum(axis=1)/30.

cumret=np.cumprod(1+ret)-1
print 'APR', ((np.prod(1.+ret))**(252./len(ret)))-1
print 'Sharpe', np.sqrt(252.)*np.mean(ret)/np.std(ret)
print 'Dusus Kaliciligi', dd.calculateMaxDD(np.array(cumret))
\end{minted}

\begin{verbatim}
APR 0.0681264455203
Sharpe 1.49474260654
Dusus Kaliciligi (-0.026051533343801503, 109.0)
\end{verbatim}

Üstteki hesapta 30'a böldük çünkü bir günde aþaðý yukarý bu kadar kar
açýklamasý yapýlýyor, 

\begin{minted}[fontsize=\footnotesize]{python}
print earnann.sum(axis=1).max()
\end{minted}

\begin{verbatim}
41
\end{verbatim}

\begin{minted}[fontsize=\footnotesize]{python}
plt.plot(cumret)
plt.title(u'Kümülatif Birleþik Getiri')
plt.savefig('tser_mom_03.png')
\end{minted}

\includegraphics[height=6cm]{tser_mom_03.png}

Üstel Yürüyen Ortalama (EWMA) ile Momentum 

Pandas'in EWMA hesabý için bir çaðrýsý var, olaðan durumunda üstelli
katsayýlarý kullanýr, fakat istenirse özyineli formda da hesap yapabilir. 
Pandas ile pencere gibi bir parametre var, buna kapsam (span)
deniyor. Kapsam $k$ ile $\alpha$ arasýndaki iliþki þöyle,

$$\alpha = 2/(k+1) $$

Örnek

Alým satým kararlarý için EWMA kullanýlabilir. Bir fiyat serisinini iki 
tane ayrý EWMA'sý alýnýr. Bu ortalamalardan bir tanesi daha yavaþ olarak
addedilir, çünkü daha geniþ bir kapsamda geriye bakar. Diðeri daha hýzlý 
addedilir, daha kýsa vadeli geriye bakar. Eðer daha hýzlý olan ortalama
daha yavaþ olanýn üzerindeyse fiyat serisi yukarý doðru bir trende
girmiþtir, alým yapýlmalýdýr, tersi var ise, satým trendine girilmiþtir,
satým yapýlmalýdýr. 

Altta ham petrol vadeli iþlem sözleþmesi (future) üzerinde örneði
görüyoruz. Ýki kapsam var, 32 ve 128. EWMA'lar birbirinin üzerine çýktýðý
noktalar alým, satým anlarý olarak kullanýlabilir.

\begin{minted}[fontsize=\footnotesize]{python}
import pandas as pd
df = pd.read_csv("oil_crude_future.csv")
df['hýzlý'] = pd.ewma(df.price, span=32)
df['yavaþ'] = pd.ewma(df.price, span=128)
\end{minted}

\begin{minted}[fontsize=\footnotesize]{python}
df[['price','hýzlý','yavaþ']].plot()
plt.annotate('Sat',xy=(50,150),xytext=(100,160),\
             arrowprops=dict(facecolor='black',width=1,shrink=0.05))
plt.annotate('Al',xy=(240,80),xytext=(200,100),\
             arrowprops=dict(facecolor='black',width=1,shrink=0.05))
plt.savefig('tser_misc_01.png')
\end{minted}

\includegraphics[height=6cm]{tser_mom_06.png}

Tabii alým ve satým olma / olmama türünden ikisel kararlar deðil. [2] alýmda
olma ve satýma olmayý sürekli baðlamda düþünüyor, yani üstteki örnekte hangi
``pozisyonda'' olunduðu hesabý için hýzlý EWMAC'ten yavaþ olan çýkartýlýyor, ve
bu fark kadar, ki bir reel sayý, posiyona giriliyor. Eðer sonuç -4.5 ise 4.5
ünite kadar açýða satýþta olmak lazým. 

Negatif Yamukluk (Negative Skew)

Momentum stratejilerinin, özelde EWMA stratejilerinin pozitif yamukluðu olduðu
hep söylenir. Böyle olup olmadýðýný kontrol edelim.

\begin{minted}[fontsize=\footnotesize]{python}
import sys; sys.path.append('../tser_voltar')
import util, pandas as pd, zipfile
f = 'CORN_price.csv'
with zipfile.ZipFile('../tser_voltar/legacycsv.zip', 'r') as z:
    df =  pd.read_csv(z.open(f),sep=',',index_col=0,parse_dates=True)
pred = util.ewma(df.PRICE,2,8)
print util.skew(df.PRICE, pred)
\end{minted}

\begin{verbatim}
1.18
\end{verbatim}

Daha ``yavaþ'' EWMA stratejilerinde negatif yamukluk görülebilir, hýzlý olanda
görülmüyor çünkü bu strateji daha hýzlý adapte oluyor, [2]'nin tarif ettiði gibi
uzun zaman azar azar kaybedip düþüþ veya çýkýþ baþlayýnca birdenbire kazanç
saðlýyor. 

Kaynaklar

[1] Chan, {\em Algorithmic Trading}

[2] Carver, {\em Systematics Trading}

\end{document}
