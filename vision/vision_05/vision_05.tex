\documentclass[12pt,fleqn]{article}\usepackage{../../common}
\begin{document}
Ders 5

Bu derste kameradaki görüntünün nasýl oluþtuðundan bahsedeceðiz. 3D tekrar
oluþturma (reconstruction) eyleminin amacý bu iþlemi tersine çevirmek, 3D
bir þekilde 2D görüntü haline geliyor, biz 2D'deki bilgiden 3D'ye geri
gitmeye uðraþýyoruz. Önceki derste kameranýn hareketini inceledik, rotasyon
ve yer deðiþtirme. Bu derste ana konu yansýtma / izdüþüm (projection), yani
3 boyutlu dünyanýn 2 boyutlu düzlem üzerine yansýmasý. 

Farklý yansýtma teknikleri vardýr, en iyi bilineni perspektif yansýtma
(perpective projection) tekniðidir. 

Görüntü oluþumunun incelenmesinin uzun bir tarihi var. Bu alandaki ilk
incelemenin M.Ö. 400 tarihine, Öklit tarafýndan yapýldýðý biliniyor. Kýsmen
doðru perspektif yansýtma örnekleri M.Ö. 1 yýlýnda Pompei'de
bulunmuþtur. Fakat bu bilgi kesintisiz bir þekilde devam etmemiþ anlaþýlan,
çünkü Rönesans'a kadar uzun bir süre diðer bilimciler, sanatçýlar
perspektif geometrisinden habersiz bir þekilde iþlerini yapmýþlar; Rönesans
öncesi yaðlýboya resimlerine bakýlýrsa çoðu resimlerdeki objelerin,
insanlarýn düz bir þekilde, derinlik bilgisi kullanýlmadan resmedildiði
görülebilir. Burada sanatçýlarýn tercihleri de rol oynamýþtýr muhakkak,
sanatýn gerçekçi deðil ikonik, temsili olmasý istenmiþ herhalde. 

Rönesans sýrasýnda perspektifsel geometri tekrar keþfedildi, ilerletildi ve
sanat bu þekilde üretilmeye baþlandý. Sanatçýlar Brunelleschi, Donatello,
Alberti bu yönde araþtýrmalar yaptýlar, hatta yansýtma süreci hakkýndaki
ilk eser {\em Della Pittura} kitabýnda Alberti'ye ait. Pür yansýtsal
geometri olmasa da mesela ýþýðýn madde ile etkileþiminin nasýl olduðu da
araþtýrýldý, 1500'lu yýlllarda ünlü Leonardo da Vinci bu konuyla çok
ilgilendi, Rönesans sanatçýlarý Caravaggio, Raphael ayný þekilde. 

Perspektif yansýtma ve görüntü oluþumda en iyi bilinen model iðne deliði
kamera (pinhole camera) modelidir. Bu model en basit haliyle bir kutuda
çok ufak bir delik açýldýðý durumdur, böylece dýþarýdan gelen objelerden
yansýyan ýþýk (ki bu ýþýk gözümüze düþtüðü için o objeleri görüyoruz
zaten), bu ufak delikten çýkarak kutuya girer.

\includegraphics[height=3cm]{pinhole3.png}
\includegraphics[height=3cm]{pinhole4.png}

Ýlginç bir durum þu; ýþýk hüzmeleri düz gitmeye mecburlar, ama ufak bir
delikten geçmeye de mecburlar. Bu durumda geometriye göre kutunun
arkasýnda, yani deliðin arkasýndaki yansýma terse dönmüþ olacaktýr. Böylece
bir perspektif yansýtma elde edeceðiz. Altta soldaki resimde temsili olarak
bunu görebiliriz. Alt saðdaki resim ise gerçek bir deneyden alýnmýþtýr,
aslýnda bu deney çok basit, bir kutu, bir mum, kutuda bir delik
yeterli. Kutunun arkasýna bakýnca hakikaten ters dönmüþ bir mum imajý
görüyoruz!

\includegraphics[height=4cm]{pinhole5.png}
\includegraphics[height=4cm]{pinhole2.png}

Ýðne deliði kamera oldukça basit bir model / teknik, az ýþýklý ortamlarda pek
baþarýlý deðil; bugünlerde delik yerine mercek (lens) kullanýlýyor, böylece
lensin farklý noktalarýna düþen ýþýk hüzmeleri arka planda görüntü oluþumu için
odaklanýyor / toparlanýyor. Merceklerin iþleyiþi hakkýnda biraz genel bilgi;
mercekte farklý noktalar ýþýðý deðiþik þekillerde ``kýrarlar'' (refract), ve bu
kýrýlma odaklama amaçlý kullanýlýr.

\includegraphics[height=6cm]{pinhole1.png}

Üstteki mercek te bir perspektif yansýtma oluþturur.

Odak noktalarý ilginç, merceðin solunda ve saðýnda iki $F$ noktasý var. Bu
noktalarýn mercege ayný uzaklýkta olmasý þart deðil, ama eðer mercek
simetrik ise (üstteki gibi) o zaman uzaklýk eþit. 

Merceðin iþleyiþine göre, herhangi bir $P$ noktasý için diyelim, eksene
paralel giren $P$ ýþýðý mercekten çýkýnca arka odak noktasýndan geçmeli,
sol odak noktasýndan giren $P$ ýþýðý mercekten çýkýnca eksene paralel
gitmeli. Böylece pek çok farklý yerden geçen ýþýk hüzmeleri ayný yerde
odaklanýyor, iðne deliði kamerasýna kýyasla daha fazla ýþýðý
toparlayabilmiþ oluyoruz. 

Üstteki modele göre perspektif yansýtmanýn formüllerini nasýl türeteceðiz?
Resimdeki iki üçgen $A,B$ önemli; mesela $P$ noktasýný alýp yerini
deðiþtirsem bu üçgenlerin þekli deðiþecektir. $A$ üçgeni $P$ noktasýnýn
yüksekliði üzerinden $Y$'yi veriyor, $B$ üçgeninin sað kýsmý ise
$y$'yi. Oranlar þöyle,

$$ \frac{Y}{Z} = -\frac{y}{f} \iff y = -f \frac{Y}{Z} $$

Eksi deðeri görüntünün ters dönmesinden ileri geliyor, mum örneðinde mumun tepe
taklak olmasýnda bu durumu görüyoruz. Dersin ilerisinde negatif iþareti
kullanmayacaðýz, görüntüyü tekrar çevirilmiþ kabul edeceðiz. Ayrýca zihinde
canlandýrmanýn kolay olmasý için mercekten geçtikten sonra üzerine görüntü düþen
algýlayýcý düzlemi sanki mercek ile dýþ nesne arasýndaymýþ gibi de hayal
edebiliriz. Matematiksel olarak bu iki iþlem (hem imajý dikey olarak, hem de
imaj perdesini mercek arkasýndan önüne almak) $x,y$ eksenlerinin iþaretlerinin
tersini kullanmak demektir. Bundan sonra iþlemlerimizi bu þekilde yapacaðýz,
aklýmýzda olsun.

\includegraphics[height=6cm]{front.png}

Perspektif transformasyonu $\pi$ o zaman þu þekilde gösterilir, 

$$ 
\pi: \mathbb{R}^3 \to \mathbb{R}^2; \qquad 
X \to x = \pi(X) =  \left[\begin{array}{l}
f \frac{X}{Z} \\ f \frac{Y}{Z}
\end{array}\right]
$$

3D objeyi 2D'ye çevirmek böyle oluyor. Görüldüðü gibi oldukça basit bir iþlem,
tek pürüz, iþlemin gayrý lineer olmasý, çünkü $Z$ ile {\em bölüyoruz}. Eðer bir
matris ile bu iþi yapýyor olsaydým (ki bu çarpma, toplama iþlemleri anlamýna
gelirdi), bu matrisin tersi ile geriye gitmek kolay olurdu. Ama üstteki durumda
iþimiz zorlaþtý, çünkü gayrý lineer bir iþlem yaptýk. Bu zorluk tüm dersimiz
boyunca bizi uðraþtýrmaya devam edecek.

Fakat en azýndan notasyonel olarak iþimizi biraz kolaylaþtýrabiliriz, eðer $x$'i
ve $\pi(X)$'i $Z$ ile çarparsak, sað tarafta bölümden kurtulmuþ oluruz, ayrýca 2
boyutta homojen kordinat sistemine geçersek

$$ 
Zx = Z \left[\begin{array}{r}
x \\ y \\ 1
\end{array}\right]  = 
\left[\begin{array}{rrrr}
f & 0 & 0 & 0 \\
0 & f & 0 & 0 \\
0 & 0 & 1 & 0
\end{array}\right]
\left[\begin{array}{r}
X \\ Y \\ Z \\ 1
\end{array}\right] = K_f \Pi_0 X
$$

Böylece gayrý lineer kýsmý ayýrmýþ olduk, ve en saðdaki eþitlikte görüldüðü gibi
sadece lineer bir çarpýmla iþ görebiliyoruz. Ayrýca içinde $f$'ler olan matrisi
$K_f$ ve $\Pi_0$ olarak ayrýþtýrabiliriz,

$$ K_f =
\left[\begin{array}{rrr}
f & f & 0 \\
0 & f & 0 \\
0 & 0 & 1
\end{array}\right], \qquad
\Pi_0 =
\left[\begin{array}{rrrr}
1 & 0 & 0 & 0\\
0 & 1 & 0 & 0\\
0 & 0 & 1 & 0
\end{array}\right]
 $$

$\Pi_0$'ya standart yansýtma matrisi (standard projection matrix) ismi
veriliyor. Bu niye faydalý? Çünkü $\Pi_0$ her durumda ayný, genel (generic) bir
matris. Sadece $K_f$ kameraya özgü bir matris, her deðiþik $f$ için (ki farklý
kameralarýn farklý $f$'leri olacaktýr) farklýdýr.

Ýlginç bir yaklaþýksallaþma $Z$'yi, yani kameradan olan uzaklýðý sabit kabul
etmektir, $Z$ yerine mesela $\lambda > 0$ diyelim; bu argüman der ki ``eðer
modellediðimiz 3D noktalar kameradan yeterince uzakta ise $Z$'yi tek bir sabit
ile gösterebiliriz''. $\lambda$ tabii ki gerçek uzaklýktýr, çünkü onu $Z$'nin
yerine geçecek þekilde seçeceðiz, ve $Z$ gerçek dünya kordinatýndan geliyor.

Biraraya Getirelim

Bu noktada her þeyi biraraya getirmeye uðraþalým - perspektif, kamera
hareketi... $X_0$ dünya kordinatlarýnda (dikkat hareket eden kamera kordinatýnda
deðil) bir 3D nokta. Bu noktayý kameranýn katý gövde hareketi üzerinden kamera
kordinatý $X$'e çevirmek istiyoruz,

$$ X = RX_0 + T $$

Homojen kordinatlarda, yani $X$ vektörünün sonuna 1 ekleyerek $X =
\left[\begin{array}{cccc} X&Y&Z&1 \end{array}\right]^T$

$$ X = gX_0 = \left[\begin{array}{rrr}
R & T \\ 0 & 1
\end{array}\right] X_0 $$

Üstteki matrisin tersi alýnabilir olduðunu hatýrlayalým. Homojen formatýna
geçmemizin bir sebebi de buydu zaten, ki üstteki matris tersi alýnabilir
olabilsin. Tamamýný bir araya koyunca,

$$ \lambda x = K_f \Pi_0 g X_0 $$

Eðer odak uzaklýðý (focal length) $f$ biliniyorsa görüntü kordinatlarýný
deðiþtirerek onu 1'e normalize edebiliriz, ki bu duruma $K_f$'i üstteki
formülden çýkartmak mümkündür,

$$ \lambda x = \Pi_0 X = \Pi_0 g X_0 $$

çünkü iki üstteki formüldeki çarpýmlara saðdan sola bakarsak dünya
kordinatýndan kameraya, oradan iki boyutlu görüntüye, ve $K_f$ olduðu
durumda odak uzaklýðý üzerinden ölçekleme yapýlýyor. Üstteki iki formülü ve
benzer form'larý saðdan sola okumak lazým.

Piksel Kordinatlarý

Dönüþtürme, deðiþtirme daha bitmedi! Bir tane daha dönüþüm lazým, 

\includegraphics[height=5cm]{pixcoord.png}

Þimdiye kadar yaptýklarýmýz bize görüntüyü üstteki resim gibi verecek. Dýþ
dünyadaki objeler $x_{cam},y_{cam}$ kordinatlarýna göre eksenlerin altýna ya da
üstüne düþebilecekleri için eksi, artý deðerlere sahip olabilecekler. Fakat biz
kameradan gelen deðerleri hep artý deðer olarak görmek istiyoruz, bu amaçla
kordinat merkezini sol alt köþeye taþýmak lazým, $o_x,o_y$ ile bunu yaparýz.

Ayrýca kameranýn görüntüsü dikey olarak yatay durumundan daha ``yassý''
olabilir, bu durumda görüntüdeki pikseller de bir dikdörtgeni
andýracaklardýr. Halbuki dýþ dünyayý herhangi bir yönde yassýlaþmýþ olarak
deðil, eþit ölçeklerde görmek isteriz, eðer varsa bu eksikliði nötralize etmek
için yatay / dikey ölçeklemeyi düzeltmemiz gerekir, buna kayký -skew- düzeltmek
deniyor) $s_\theta$ ile yapýlýr, fakat pratikte biz bu durumun olmadýðýný farz
edeceðiz.

Bir ölçekleme daha, piksel kordinatlarý birim ölçekte deðil ise bunu da
$s_x,s_y$ ile düzeltebiliriz. 

Hepsi bir arada tek matris $K_s$ içinde

$$ K_s = \left[\begin{array}{rrr}
s_x & s_\theta & o_x \\
0 & s_y & o_y \\
0 & 0 & 1
\end{array}\right] $$

Hepsi bir arada

$$ 
\lambda
\left[\begin{array}{c}
x' \\ y' \\ 1
\end{array}\right]
=
\underbrace{
\left[\begin{array}{rrr}
s_x & s_\theta & o_x \\
0 & s_y & o_y \\
0 & 0 & 1
\end{array}\right]
}_{K_s}
\underbrace{
\left[\begin{array}{rrr}
f & f & 0 \\
0 & f & 0 \\
0 & 0 & 1
\end{array}\right]}_{K_f}
\underbrace{
\left[\begin{array}{rrrr}
1 & 0 & 0 & 0\\
0 & 1 & 0 & 0\\
0 & 0 & 1 & 0
\end{array}\right]}_{\Pi_0}
\left[\begin{array}{r}
X \\ Y \\ Z \\ 1
\end{array}\right]
 $$

Elimizde pek çok transformasyon matrisi var artýk. Peki bu matrislerden hangisi
kameranýn içsel yapýsýyla alakalýdýr acaba? Yani marka ABC satýn alýyorum, ya da
onun yerine marka XYZ alýyorum; bu iki kamera arasýndaki imalatla alakalý hangi
parametreler birinden ötekine deðiþir? Odak uzaklýðý $f$ bunlardan biri, bu
parametre kameranýn görüntü uzaklaþtýrma, yakýnlaþtýrma (zoom in, out), yani
donanýmý ile alakalý bir durum.

$K_s$ matrisi de kameranýn iç yapýsýyla, donaným ayarlarýyla alakalý. Mesela bir
kameradaki çözünürlüðü deðiþtirdiðimiz zaman $K_s$ içindeki deðerleri
deðiþtirmemiz gerekir.

O zaman bu iki matrisi birleþtirebiliriz, $K = K_sK_f$, ki $K$'ye içsel parametre
matrisi (intrinsic parameter matrix) adý verilir.

$$ K = K_sK_f = \left[\begin{array}{rrr}
fs_x & fs_\theta & o_x \\
0 & fs_y & o_y \\
0 & 0 & 1
\end{array}\right] $$

Daha kýsa olarak $\alpha_x = fs_x,\alpha_y=fs_y$. En-boy oraný (aspect
ratio) ise $\sigma = \alpha_x/\alpha_y$.

Devam edelim,

$$ \lambda x = K\Pi_0 X = K \Pi_0 g X_0 = \Pi X_0 $$

Dikkat, yeni bir $\Pi$ matrisi var, bu bir $3 \times 4$ matris ve $\Pi =
K\Pi_0g$ olarak tanýmlý. Bu matrise genel yansýtma matrisi (general projection
matrisi) adý veriliyor. $\Pi = (KR, KT)$ yani.

$K$ matrisi içsel parametreler ise, dýþsal parametreler $g$ içinde. Bir
kamerayý hareket ettirdiðimizde içsel parametreleri ayný kalacak, dýþsal
parametreler 6 serbestlik derecesi üzerinden deðiþecek.

Konumuzdaki çoðu uygulama iki ana dala ayrýlabilir, kamera kalibrasyonu bilinen
durum, ya da bilinmeyen durum. Kamera bizimse hesaplarýmýza baþlamadan önce onu
inceleyip, odak uzaklýðýný kendimiz set edip kalibrasyonu öðrenebiliriz, yani
$K$ bilinir. Bu kolay senaryo. Kalibrasyonsuz durum da olabilir; elimizde sadece
arka arkaya ``bir'' kameradan gelmiþ görüntüler var, ama kamera hakkýnda hiçbir
þey bilmiyoruz. Ýtiraf etmek gerekirse bu senaryo oldukça iþleri zorlaþtýrýyor.

Not: Bazý görüntü dosyalarýnýn içinde içsel parametreler kaydedilmiþ
olabiliyor bu arada, Ýnternet'ten bir sürü resim indirip 3D tekrar
oluþturma yapmak istenirse bunu akýlda tutmak faydalý.

Tüm bunlardan sonra $x',y'$ formülüne dönelim, unutmayalým üstteki
transformasyonlar lineer deðil demiþtik, $Z$ ile, yani $\lambda$ ile bölüm
gerekiyordu, o zaman nihai sonuç

$$ 
x ' = \frac{\pi_1^TX_0}{\pi_3^TX_0}, \qquad
y ' = \frac{\pi_2^TX_0}{\pi_3^TX_0}, \qquad
z' = 1
$$

ki $\pi_1^T,\pi_2^T,\pi_3^T \in \mathbb{R}^4$ yansýtma matrisi $\Pi$'nin satýrlarý. 

[Küresel perspektif izdüþümü, yarýçapsal yamultma (radial distortion),
preimage, coimage atlandý]

Ekler

[1]'deki programý kullanarak kamera matris parametrelerindeki deðiþimin
görüntüye nasýl yansýdýðýný görebiliriz. Her resim tek bir parametrenin
deðiþtirilmesiyle elde edilmiþtir. 

Odak Uzaklýðý

\includegraphics[height=6cm]{05_01.png}
\includegraphics[height=6cm]{05_02.png}

Kayký, $x_0$

\includegraphics[height=6cm]{05_03.png}
\includegraphics[height=6cm]{05_04.png}

$y_0$

\includegraphics[height=6cm]{05_05.png}
\includegraphics[height=6cm]{05_06.png}


Kaynaklar

[1] Kyle Simek, Dissecting the Camera Matrix, Part 3: The Intrinsic Matrix,
\url{http://ksimek.github.io/2013/08/13/intrinsic/}

\end{document}



