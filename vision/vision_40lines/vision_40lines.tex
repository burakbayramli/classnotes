\documentclass[12pt,fleqn]{article}\usepackage{../../common}
\begin{document}
Birleþme Noktalarý, Çizgiler, Hiperdüzlemler (Vanishing Points, Lines, Hyperplanes)

Görüntü iþlemede birleþme noktalarý ufuk çizginde, dýþ dünyadaki genel
yapýnýn ``aktýðý'' yer olarak tanýmlanabilir. Mesela önümüzde düz giden bir
yol var ise o yolun ufuk çizgisine deðdiði yer birleþme
noktasýdýr. Birleþme noktalarýnýn bir nokta olarak ortaya çýkmasýnýn sebebi
3D-2D dönüþümüyle alakalý; üç boyutta parallel olan çizgilerin iki boyuta
(diijal kameraya) yansýmasý onlarin tek noktada birleþmesine sebep olur.

\includegraphics[width=8em]{vision_40lines_05.png}
\includegraphics[width=10em]{vision_40lines_07.png}
\includegraphics[width=14em]{vision_40lines_10.png}

Üstte bazý örnekler görüyoruz. Soldaki imajda birleþme noktasý tren
raylarýnýn görülebilen son noktasýdýr. Ortadaki imajda kýrmýzý çizgilerin
birleþtiði yer. Bir resimde birden fazla birleþme noktasý da olabilir,
mesela saðdaki resimde bu örnek görülüyor. Birleþme noktasý imaj dýþýna da
düþüyor olabilir, yine saðdaki resim.

Görüntülerde derinliði anlamak, bu konuyu incelemek Rönesans'da baþladý. Bu
çaðda görüntünün ne olduðu ciddi þekilde araþtýrýldý, ressamlar perspektifi
dikkate alýp, birleþme noktalarýný seçip ona göre resimlerini yapmaya
baþladýlar. Mesela ünlü ressam Raphael'ýn {\em Atina Okulu} adlý resmi [4].

\includegraphics[width=30em]{athens.jpg}

Bu resimde birleþme noktasý filozof Sokrat'ýn sol elinde, resimdeki tüm
objeler bu noktaya göre þekillendirilmiþ.

Birleþme Noktalarýný Bulmak

Görüntü iþleme çerçevesinde verili herhangi bir görüntüde birleþme
noktalarýný bulmak faydalý oluyor; bu noktalar robotik, yer bulma amaçlý
olarak kullanýlabiliyor. Çünkü eðer görüntüdeki genel yapýnýn nereye doðru
aktýðýný bulabiliyorsak, oraya doðru bir fiziksel gidiþ de vardýr demektir,
ve otonom hareket eden robotlar bu bilgiyi kullanabilirler, ya da bu bilgi
diðer ek görüntü iþleme adýmlarý için bir girdi olabilir. Belki elde
tutulan kamera sürekli sallanýyordur, ama birleþim noktasýný her görüntüde
doðru bulabiliyorsak bu bu bilgiyi bir stabilizasyon amaçlý kullanabiliriz.

Hesap icin ilk aþama görüntüdeki ana çizgileri bulmak. Ana çizgileri bulmak
artýk görüntü iþlem biliminde demirbaþ haline gelmiþ Canny kenar bulucusu
ve Hough transformu ile yapýlabilir.

\begin{minted}[fontsize=\footnotesize]{python}
from PIL import Image, ImageDraw
from skimage.transform import  probabilistic_hough_line
from skimage.feature import canny
from skimage import data
import pandas as pd
\end{minted}

\begin{minted}[fontsize=\footnotesize]{python}
im1 = Image.open('in1.jpg').convert('L')
edges1 = canny(np.array(im1), 2, 1, 25)
lines1 = probabilistic_hough_line(edges1, threshold=10, line_length=30,line_gap=3)
im1 = Image.open('in1.jpg')
for line in lines1:
    p0, p1 = line
    plt.plot((p0[0], p1[0]), (p0[1], p1[1]))
plt.imshow(im1)
plt.savefig('vision_40lines_08.png')
\end{minted}

\includegraphics[width=30em]{vision_40lines_08.png}

\begin{minted}[fontsize=\footnotesize]{python}
im2 = Image.open('in2.jpg').convert('L')
edges2 = canny(np.array(im2), 2, 1, 25)
lines2 = probabilistic_hough_line(edges2, threshold=10, line_length=30,line_gap=3)
im2 = Image.open('in2.jpg')
for line in lines2:
    p0, p1 = line
    plt.plot((p0[0], p1[0]), (p0[1], p1[1]))
plt.imshow(im2)
plt.savefig('vision_40lines_09.png')
\end{minted}

\includegraphics[width=30em]{vision_40lines_09.png}

Hough transformuna verilen \verb!threshold!, \verb!line_length!,
\verb!line_gap! parametreleri algoritmanýn hassasiyetini ayarlýyor, mesela
\verb!line_length! bulunan çizgilerin en az kaç piksel olmasý gerektiðini
tanýmlýyor.

Bir sonraki adým bu ana çizgileri alýp onlarýn birleþebilecek olanlarýný
seçmek, ve en çok birleþim yapabilenleri üzerinden bir birleþim noktasý
bulmak. Ama önce iki boyutta çizgiler nasýl formüle edilir, ve kesiþim
nasýl bulunur, onu görelim.

Çizgiler

Bir çizgiyi $ax+by+c = 0$ genel formülüyle gösterebiliriz. $a,b,c$
parametreleri özgün olarak iki boyutta bir çizgiyi tanýmlayabilir, bu
formülü tatmin eden sonsuza kadar tüm $x,y$ deðerleri çizginin
parçasýdýr. 

Üstteki formülü lise matematiðinden bilinen $y=mx+i$'e iliþkilendirmek
için, ki $m$ eðim (slope) ve $i$ kesi (intercept),

$$ ax+by+c = 0 $$

$$ by = -ax -c$$

$$ y = -a/b x -c/b$$

Yani eðim $m=-a/b$, kesi $-c/b$. Bu bilgiyi vektörel bir yön tanýmlamak
için þöyle düþünebiliriz, eðime göre $x$ yönünde atýlan her $b$ adýmý için
$y$ yönünde $-a$ adýmý atýlacaðýna göre (ya da $-b$ için $a$ adýmý), vektör
alttaki gibi olur.

\includegraphics[width=15em]{vision_40lines_06.png}

Birkaç örneði grafikleyelim,

\begin{minted}[fontsize=\footnotesize]{python}
import pandas as pd

def plot_line(a,b,c):
    # Formula is ax+by+c = 0 
    x = np.linspace(-20,20,1000)    
    m = -a/b # slope
    i = -c/b # intercept
    y = m*x + i
    plt.plot(x,y,'.')

l1 = np.array([1,1,-5])
plot_line(l1[0],l1[1],l1[2])
l2 = np.array([2,-1,10])
plot_line(l2[0],l2[1],l2[2])
plt.xlim(-10,10)
plt.ylim(0,30)
plt.grid(True)
plt.savefig('vision_40lines_01.png')
\end{minted}

\includegraphics[width=15em]{vision_40lines_01.png}

Homojen Kordinatlar, Kesiþim

Homojen kordinatlarýn $(u,v,1)$ þeklinde olduðunu hatýrlayalým, ki
$(uw,vw, w)$ ayný kordinat oluyordu, çünkü bir homojen kordinatin
3. hücresinde ne varsa tüm kordinat degerlerini onunla bölebiliyorduk [1].

Kartezyen düzlemde çizgi denklemi $ax+by+c=0$'i þu þekilde görebiliriz,
$x,y$ çizgi üzerinde birer noktadýr, homojen baðlamda $x=u/w$, $y=v/w$
olsun, o zaman $w$ ile çarparak, yani bu homojen $(u,v,w)$ noktasýný ileri
/ geri hareket ettirerek tüm çizgiyi kapsayabiliriz. Bu tanýmlarý Kartezyen
çizgi denklemine geri sokarsak, çizgiyi homojen olarak
tanýmlayabileceðimizi görürüz,

$$ au + bv + w = 0$$

Bu denklem homojen çizgi denklemi olarak biliniyor. Yani bir çizgiyi 

$$ \ell = (a,b,c)$$

homojen kordinatlarýyla tanýmlayabiliriz. $\ell$'in sýfýr olmayan herhangi
bir katý ayný çizgiyi tanýmlayacaðýna göre $\ell$'yi bir yön olarak
düþünmek te mümkün, ve çizgi için yönden baþka bir þeye zaten ihtiyaç yok.

Tüm bu tanýmlara göre $p=(u,v,w)$'nin homojen kordinatta bir nokta olduðunu
düþünelim. O zaman $p$'nin bir çizgi üzerinde olmasý demek, $p$ ve
$\ell$'nin noktasal çarpýmýnýn sýfýr olmasý demektir,

$$ p \cdot \ell = 0$$

Deðil mi? Çünkü 

$$ 
au + bv + cw = 
\left[\begin{array}{r}
a \\ b \\ c
\end{array}\right] 
\cdot
\left[\begin{array}{r}
u \\ v \\ w
\end{array}\right] = 0
$$

O zaman iki çizginin kesiþimini þöyle buluruz. Diyelim ki iki çizgi $\ell_1$
ve $\ell_2$'nin kesiþme noktasý $p$, o zaman

$$ \ell_1 \cdot p = 0, \qquad \ell_2 \cdot p = 0$$

ki herþey homojen kordinatta. Üstteki tanýmlardan þu sonuç çýkýyor, $p$ hem
$\ell_1$ hem de $\ell_2$'ye dikgendir. Ýki vektöre dikgen olan üçüncü bir
vektörü nasýl buluruz? Çapraz çarpýmla! Yani $p = \ell_1 \times \ell_2$. O
zaman kesiþim noktasýnýn hesabý gayet basit, mesela üstteki örnek için

\begin{minted}[fontsize=\footnotesize]{python}
p = np.cross(l1,l2) 
print p / p[2]
\end{minted}

\begin{verbatim}
[-2  6  1]
\end{verbatim}

Hakikaten de kesiþim noktasýnýn $x=-2,y=6$'da olduðunu görebiliyoruz. 

Ayný mantýkla iki noktadan geçen bir çizginin formülünü bulmak için þunun
doðru olduðundan hareket edebiliriz,

$$ p_1 \cdot \ell = 0, \qquad p_2 \cdot \ell = 0$$

O zaman bilinen iki noktadan geçen çizgi bu iki noktanýn (homojen
kordinatýndaki) çapraz çarpýmýdýr! 

Örnek

(3,1) ve (-4,5)'den geçen çizginin formülü nedir? 

Cevap

Bu formül 

$$ \ell \cdot (3,1,1) = 0$$

$$ \ell \cdot (-4,5,1) = 0$$

denklemlerini tatmin etmelidir. O zaman çizgi 

\begin{minted}[fontsize=\footnotesize]{python}
print np.cross(np.array([3,1,1]), np.array([-4,5,1]))
\end{minted}

\begin{verbatim}
[-4 -7 19]
\end{verbatim}

olacaktýr. Yani çizgi formülü $4x + 7y - 19 = 0$. 

Yol bulmak amaçlý yol sonunu gösteren kesiþim noktasýný bulmak için bir
algoritma þöyle olabilir,

1. Görüntüdeki yeterince büyük olan tüm çizgileri bul (çizgiler Hough
transformdan baþlangýç bitiþ noktalarý ile tanýmlý, bunlarý çapraz çarpýmý
ile çizgi formülüne çevir).

2. Tüm çizgiler arasýndaki ikili kombinasyonlara teker teker bak, ve
aralarýndaki kesiþim noktasýný hesapla. 

3. Ýmajýn orta noktasýna uzak olan noktalarý ele. 

4. Ortalamayý al.

\begin{minted}[fontsize=\footnotesize]{python}
import itertools

def vanish(fin):
    im = Image.open(fin).convert('L')
    edges = canny(np.array(im), 2, 1, 25)
    lines = probabilistic_hough_line(edges, threshold=20, line_length=30,line_gap=3)
    im = Image.open(fin)
    new_lines = []
    for line in lines:
        p1 = np.array([1,1,1]); p1[:2] = line[0] 
        p2 = np.array([1,1,1]); p2[:2] = line[1] 
        new_lines.append(np.cross(p1,p2))
    res = []
    for (l1,l2) in itertools.product(new_lines,new_lines):
        if np.all(l1==l2): continue
        inters = np.cross(l1,l2) 
        inters = inters / inters[2]
        if np.sqrt((160-inters[0])**2 + (120-inters[1])**2) < 100: 
            res.append(inters)
    res = np.array(res)
    vanish = res.mean(axis=0)
    return im, lines, vanish
\end{minted}

\begin{minted}[fontsize=\footnotesize]{python}
im, lines, vp = vanish('in1.jpg')
for line in lines:
    p0, p1 = line
    plt.plot((p0[0], p1[0]), (p0[1], p1[1]))
plt.plot(vp[0], vp[1],'rd')
plt.imshow(im)
plt.savefig('vision_40lines_11.png')
\end{minted}

\includegraphics[width=30em]{vision_40lines_11.png}

\begin{minted}[fontsize=\footnotesize]{python}
im, lines, vp = vanish('in2.jpg')
for line in lines:
    p0, p1 = line
    plt.plot((p0[0], p1[0]), (p0[1], p1[1]))
plt.plot(vp[0], vp[1],'rd')
plt.imshow(im)
plt.savefig('vision_40lines_12.png')
\end{minted}

\includegraphics[width=30em]{vision_40lines_12.png}

Farklý birleþim nokta hesaplarý [2, sf. 21]'de bulunabilir.

Hiperdüzlemler

Hiperdüzlemler ve yarý uzaylar (halfspace) konusuna da bakalým. Bu kavram
Destek Vektör Makinalarý tekniði için çok önemli.

Bir düzlemi tanýmlamak için bir vektör yeterli, mesela 2 boyutta düþünelim,
$\left[\begin{array}{cc}1 & 2 \end{array}\right]^T$ vektörü, bu vektöre
dikgen olan tüm vektörlerin uzayý sonsuza giden bir çizgi oluþturur. Örnek
[4, sf. 378], orijinden geçen çizgi.

\includegraphics[height=6cm]{vision_40lines_02.png}

Bu çizgi $x + 2y = 0$, $w^Tu = 0 $ olarak ta temsil edilebilir, vektör çarpým
sonucunun sýfýr olduðuna dikkat, bu dikgenlikten ileri geliyor. Ýkinci çarpýmda
notasyon deðiþti, $u = \left[\begin{array}{cc}x & y \end{array}\right]^T$, ve $w
= \left[\begin{array}{cc}1 & 2 \end{array}\right]^T$ oldu, ama sonuç ayný.

Bu çizginin tüm uzayý ikiye böldüðü de söylenebilir, ortaya iki yarý uzay ortaya
çýkartarak.

Yarý uzayýn nasýl tanýmlandýðýný anlamadan önce, eðer $x + 2y = 0$'i 2 yukarý
çýkartmak istesek, $x + 2y = 4$ kullanabileceðimizi görelim, grafikte görüldüðü
gibi. O zaman $x + 2y = 4$ çizgisinin böldüðü yarý uzaylar,

$$ x = 2y \ge 4  $$

$$ x = 2y < 4  $$

olarak tanýmlanabilir, çünkü bir çizginin üstünde ya da altýnda kalmak üstteki
þekilde eþitsizlikler olarak ortaya çýkartacaktýr.

Bazý örnekler, ve grafikleme rutinleri görelim,

\begin{minted}[fontsize=\footnotesize]{python}
def plot_sep(w,color='blue'):
    Q = np.array([[0, -1],[1, 0]])
    x = np.linspace(-20,20,1000)
    w2 = np.dot(Q,w[:2])
    m = w2[1]/w2[0]
    y = m*x + (-w[2]/w[1])
    plt.plot(x,y,'.',color=color)

a = np.array([1., 2., -4])
plot_sep(a)
plt.xlim(-5,5)
plt.ylim(-5,5)
plt.grid(True)
plt.savefig('14_4.png')
\end{minted}

\includegraphics[height=6cm]{vision_40lines_03.png}

Noktalarýn çizginin neresine düþtüðünden hareketle bazý $wx + b$ sonuçlarý

\begin{minted}[fontsize=\footnotesize]{python}
a1 = np.array([2., 2., -50.])
plot_sep(a1,color='green')
a2 = np.array([-1., 1., -4.])
plot_sep(a2,color='blue')

pt = np.array([10.,10.,1.])
plt.plot(pt[0],pt[1],'gd')
print np.dot(a1,pt)
print np.dot(a2,pt)

pt = np.array([14.,15.,1.])
plt.plot(pt[0],pt[1],'rd')
print np.dot(a1,pt)
print np.dot(a2,pt)

pt = np.array([8.,18.,1.])
plt.plot(pt[0],pt[1],'rx')
print np.dot(a1,pt)
print np.dot(a2,pt)

plt.xlim(5,15)
plt.ylim(0,20)
plt.savefig('14_5.png')
\end{minted}

\begin{verbatim}
-10.0
-4.0
8.0
-3.0
2.0
6.0
\end{verbatim}

\includegraphics[height=6cm]{vision_40lines_04.png}

Kaynaklar 

[1] Jia, {\em Problem Solving Techniques for Applied Computer Science},
    \url{http://web.cs.iastate.edu/~cs577/}

[2] Hoiem, {\em Representations and Techniques for 3D Object Recognition and Scene Interpretation}

[3] Strang, {\em Linear Algebra and Its Applications, 4th Ed}

[4] Taylor, Kubovy, {\em The Role of Perspective}, \url{http://www.webexhibits.org/sciartperspective/perspective3.html}

\end{document}
